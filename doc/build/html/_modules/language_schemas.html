<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>language_schemas &mdash; TCG 1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TCG 1.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TCG 1.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for language_schemas</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Victor Barres</span>
<span class="sd">Defines language schemas for TCG.</span>

<span class="sd">Uses NetworkX for the implementation of the content of the Semantic Working Memory (SemRep graph)</span>
<span class="sd">Uses Numpy for vectorial operations.</span>
<span class="sd">Uses pyttsx for the text to speech implementation (optional!)</span>
<span class="sd">Uses re for regular expression parsing of sem inputs (optional)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">pyttsx</span>


<span class="kn">from</span> <span class="nn">schema_theory</span> <span class="kn">import</span> <span class="n">KNOWLEDGE_SCHEMA</span><span class="p">,</span> <span class="n">SCHEMA_INST</span><span class="p">,</span> <span class="n">PROCEDURAL_SCHEMA</span><span class="p">,</span> <span class="n">LTM</span><span class="p">,</span> <span class="n">WM</span><span class="p">,</span> <span class="n">ASSEMBLAGE</span>
<span class="kn">import</span> <span class="nn">construction</span>
<span class="kn">import</span> <span class="nn">TCG_graph</span>

<span class="c">##################################</span>
<span class="c">### Language knowledge schemas ###</span>
<span class="c">##################################</span>

<span class="c">################################</span>
<span class="c"># GRAMMATICAL KNOWLEDGE SCHEMA #</span>
<div class="viewcode-block" id="CXN_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CXN_SCHEMA</span><span class="p">(</span><span class="n">KNOWLEDGE_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construction schema</span>
<span class="sd">    </span>
<span class="sd">    Data:</span>
<span class="sd">        - KNOWEDGE SCHEMA data:</span>
<span class="sd">                    - id (int): Unique id</span>
<span class="sd">                    - name (str): schema name</span>
<span class="sd">                    - LTM (LTM): Associated long term memory.</span>
<span class="sd">                    - content (CXN):</span>
<span class="sd">                    - init_act (float): Initial activation value.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aCXN</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="n">KNOWLEDGE_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">aCXN</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">aCXN</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="n">init_act</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CXN_SCHEMA_INST"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST">[docs]</a><span class="k">class</span> <span class="nc">CXN_SCHEMA_INST</span><span class="p">(</span><span class="n">SCHEMA_INST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (Production) construction instance</span>
<span class="sd">    </span>
<span class="sd">    If copy= True, carries a copy of the construction stored in LTM. </span>
<span class="sd">    Trace contains pointers to both the SemRep subgraphs that triggered the instantiation and to the CXN_SCHEMA in LTM that was instantiated.</span>
<span class="sd">    </span>
<span class="sd">    Data:</span>
<span class="sd">        SCHEMA_INST:</span>
<span class="sd">            - id (int): Unique id</span>
<span class="sd">            - activity = The current activity level of the schema.</span>
<span class="sd">            - activation (INST_ACTIVATION): Handles the activation dynamics.</span>
<span class="sd">            - content (CXN):</span>
<span class="sd">            - in_ports ([PORT]):</span>
<span class="sd">            - out_ports ([PORT]):</span>
<span class="sd">            - alive (bool): status flag</span>
<span class="sd">            - trace ({&quot;SemRep&quot;:{&quot;nodes&quot;:[], &quot;edges&quot;=[]}, &quot;schemas&quot;:[CXN_SCHEMA]}): Pointer to the elements that triggered the instantiation.</span>
<span class="sd">            - covers ({&quot;nodes&quot;:{}, &quot;edges&quot;={}}): maps CXN.SemFrame nodes and edges (in content) to SemRep elements (in the trace) (Maps the nodes and edges names to SemRep obj)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">SCHEMA_INST</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="p">(</span><span class="n">cxn_copy</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">cxn_schema</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">cxn_copy</span>
                <span class="k">if</span> <span class="n">mapping</span><span class="p">:</span>
                    <span class="n">new_node_mapping</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
                    <span class="n">new_edge_mapping</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
                    <span class="n">new_mapping</span><span class="o">=</span> <span class="p">{</span><span class="s">&#39;nodes&#39;</span><span class="p">:</span><span class="n">new_node_mapping</span><span class="p">,</span> <span class="s">&#39;edges&#39;</span><span class="p">:</span><span class="n">new_edge_mapping</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">covers</span> <span class="o">=</span> <span class="n">new_mapping</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">covers</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ports</span><span class="p">()</span>
    
<div class="viewcode-block" id="CXN_SCHEMA_INST.set_ports"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST.set_ports">[docs]</a>    <span class="k">def</span> <span class="nf">set_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ports</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">out_ports</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the input and output port for the construction schema instance.</span>
<span class="sd">        Each instance has 1 output port.</span>
<span class="sd">        Each instance has an input port for each TP_SLOT element in the construction&#39;s SynForm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_ports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_ports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">in_ports</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">SynForm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SynForm</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">SynForm</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">construction</span><span class="o">.</span><span class="n">TP_SLOT</span><span class="p">):</span> <span class="c"># 1 intput port per slot</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="n">port_name</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">port_data</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">in_ports</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">port</span><span class="o">.</span><span class="n">schema</span><span class="o">=</span><span class="bp">self</span>
        
        <span class="k">if</span> <span class="n">out_ports</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">SemFrame_head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SemFrame</span><span class="o">.</span><span class="n">get_head</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="n">port_data</span><span class="o">=</span><span class="n">SemFrame_head</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">out_ports</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">port</span><span class="o">.</span><span class="n">schema</span><span class="o">=</span><span class="bp">self</span>
            </div></div>
<div class="viewcode-block" id="CXN_SCHEMA_INST_C"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST_C">[docs]</a><span class="k">class</span> <span class="nc">CXN_SCHEMA_INST_C</span><span class="p">(</span><span class="n">CXN_SCHEMA_INST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehension construction instance.</span>
<span class="sd">    </span>
<span class="sd">    Added:</span>
<span class="sd">        - form_sequence</span>
<span class="sd">        - form_state</span>
<span class="sd">        - phon_cover</span>
<span class="sd">        - has_predicted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">CXN_SCHEMA_INST</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="o">=</span><span class="n">cxn_schema</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">mapping</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SynForm</span><span class="o">.</span><span class="n">form</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_sequence</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="c"># Simply so that the sequence can be used as stack in python.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_sequence</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phon_cover</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Should be reorganized with covers. Mapping should also be introduced by reworking the relations with constructions instances used for production.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_predicted</span> <span class="o">=</span> <span class="bp">False</span>
    
<div class="viewcode-block" id="CXN_SCHEMA_INST_C.cxn_predictions"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST_C.cxn_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">cxn_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the set of cxn classes that are predicted by this construction given its current form_state. </span>
<span class="sd">        Classes that are predicted are those that fit the constraints of next(state) if it is a slot.</span>
<span class="sd">        No predictions are issued if instance is in COMPLETE state or if next(state) is not a slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_state</span><span class="p">,</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_SLOT</span><span class="p">)):</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_state</span><span class="o">.</span><span class="n">cxn_classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_predicted</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">predictions</span>
    </div>
<div class="viewcode-block" id="CXN_SCHEMA_INST_C.phon_prediction"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST_C.phon_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">phon_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return, if the form_state is a TP_PHON, the word_form the cxn is exptecting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">word_form</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span> <span class="ow">and</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form_state</span><span class="p">,</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_PHON</span><span class="p">)):</span>
            <span class="n">word_form</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span><span class="o">.</span><span class="n">cxn_phonetics</span>
        <span class="k">return</span> <span class="n">word_form</span>
        </div>
<div class="viewcode-block" id="CXN_SCHEMA_INST_C.next_state"><a class="viewcode-back" href="../code.html#language_schemas.CXN_SCHEMA_INST_C.next_state">[docs]</a>    <span class="k">def</span> <span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move to next state along the form sequence (defined by the SynForm).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_sequence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_sequence</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_predicted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form_state</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c">#############################</span>
<span class="c"># CONCEPT KNOWLEDGE SCHEMAS #</span></div></div>
<div class="viewcode-block" id="CPT_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CPT_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CPT_SCHEMA</span><span class="p">(</span><span class="n">KNOWLEDGE_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concept schema</span>
<span class="sd">    Data:</span>
<span class="sd">    - KNOWEDGE SCHEMA data:</span>
<span class="sd">        - id (int): Unique id</span>
<span class="sd">        - name (str): schema name</span>
<span class="sd">        - LTM (LTM): Associated long term memory.</span>
<span class="sd">        - content ({&#39;concept&#39;:CONCEPT): concept is a CONCEPT in SEMANTIC_NETWOR</span>
<span class="sd">        - init_act (float): Initial activation value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - name (STR):</span>
<span class="sd">            - concept (CONCEPT):</span>
<span class="sd">            - init_act (FLOAT):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">KNOWLEDGE_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="n">init_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_content</span><span class="p">({</span><span class="s">&#39;concept&#39;</span><span class="p">:</span><span class="n">concept</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="CPT_ENTITY_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CPT_ENTITY_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CPT_ENTITY_SCHEMA</span><span class="p">(</span><span class="n">CPT_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conceptual entity schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="n">CPT_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CPT_ACTION_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CPT_ACTION_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CPT_ACTION_SCHEMA</span><span class="p">(</span><span class="n">CPT_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conceptual action schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="n">CPT_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CPT_PROPERTY_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CPT_PROPERTY_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CPT_PROPERTY_SCHEMA</span><span class="p">(</span><span class="n">CPT_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conceptual property schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="n">CPT_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CPT_RELATION_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.CPT_RELATION_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">CPT_RELATION_SCHEMA</span><span class="p">(</span><span class="n">CPT_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conceptual relation schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="n">CPT_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="CPT_SCHEMA_INST"><a class="viewcode-back" href="../code.html#language_schemas.CPT_SCHEMA_INST">[docs]</a><span class="k">class</span> <span class="nc">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">SCHEMA_INST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concept schema instance. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">SCHEMA_INST</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">content_copy</span> <span class="o">=</span> <span class="n">cpt_schema</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content_copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unbound</span> <span class="o">=</span> <span class="bp">False</span>
        
<div class="viewcode-block" id="CPT_SCHEMA_INST.match"><a class="viewcode-back" href="../code.html#language_schemas.CPT_SCHEMA_INST.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_inst</span><span class="p">,</span> <span class="n">match_type</span> <span class="o">=</span> <span class="s">&quot;is_a&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if it;s concept matches that of cpt_inst. </span>
<span class="sd">        Uses CONCEPTUAL_KNOWLEDGe.match() method.</span>
<span class="sd">            Type = &quot;is_a&quot;:  concept1 matches concept2 if concept1 is a hyponym of concept2 (or equal to concept2)</span>
<span class="sd">            Type = &quot;equal&quot;: concept1 matches concept2 if concept1 is equal to concept2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">],</span> <span class="n">match_type</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="CPT_SCHEMA_INST.similarity"><a class="viewcode-back" href="../code.html#language_schemas.CPT_SCHEMA_INST.similarity">[docs]</a>    <span class="k">def</span> <span class="nf">similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a similarity score between it&#39;s concept and that of cpt_inst.</span>
<span class="sd">        Uses CONCEPTUAL_KNOWLEDGE.similarity() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">similarity</span><span class="p">(</span><span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">])</span>

<span class="c">#########################</span>
<span class="c"># PHON KNOWLEDGE SCHEMA #</span></div></div>
<div class="viewcode-block" id="PHON_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.PHON_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">PHON_SCHEMA</span><span class="p">(</span><span class="n">KNOWLEDGE_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phonological form schemas.</span>
<span class="sd">    NOTE:</span>
<span class="sd">        - For now the model only deals with word level phonological form, ignoring phoneme level processes.</span>
<span class="sd">        - For now, there is no distinction between PHON_SCHEMA used during production and those used during comprehension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">word_form</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - name (STR):</span>
<span class="sd">            - word_form (STR):</span>
<span class="sd">            - init_act (FLOAT):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">KNOWLEDGE_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="n">init_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_content</span><span class="p">({</span><span class="s">&#39;word_form&#39;</span><span class="p">:</span><span class="n">word_form</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="PHON_RELATION_SCHEMA"><a class="viewcode-back" href="../code.html#language_schemas.PHON_RELATION_SCHEMA">[docs]</a><span class="k">class</span> <span class="nc">PHON_RELATION_SCHEMA</span><span class="p">(</span><span class="n">KNOWLEDGE_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UNUSED! For now the PhonologicalWM contains a sequence of PHONS_SCHEMA_INST that define word_forms.</span>
<span class="sd">    Temporal relation between phonological form schemas.</span>
<span class="sd">    NOTE:</span>
<span class="sd">         For now only &#39;next&#39; is implemented.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">phon_rel</span><span class="p">,</span> <span class="n">init_act</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - name (STR):</span>
<span class="sd">            - phon_rel (STR):</span>
<span class="sd">            - init_act (FLOAT):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">KNOWLEDGE_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="n">init_act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_content</span><span class="p">({</span><span class="s">&#39;phon_rel&#39;</span><span class="p">:</span><span class="n">phon_rel</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="PHON_SCHEMA_INST"><a class="viewcode-back" href="../code.html#language_schemas.PHON_SCHEMA_INST">[docs]</a><span class="k">class</span> <span class="nc">PHON_SCHEMA_INST</span><span class="p">(</span><span class="n">SCHEMA_INST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phonological schema instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phon_schema</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">SCHEMA_INST</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">phon_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">content_copy</span> <span class="o">=</span> <span class="n">phon_schema</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content_copy</span>

<span class="c">###################################</span>
<span class="c">### Language procedural schemas ###</span>
<span class="c">###################################</span>

<span class="c">#################</span>
<span class="c">### SEMANTICS ###</span></div>
<div class="viewcode-block" id="CONCEPTUALIZER"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPTUALIZER">[docs]</a><span class="k">class</span> <span class="nc">CONCEPTUALIZER</span><span class="p">(</span><span class="n">PROCEDURAL_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Conceptualizer&#39;</span><span class="p">):</span>
        <span class="n">PROCEDURAL_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_visual_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_concept_LTM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conceptualization</span> <span class="o">=</span> <span class="bp">None</span>
    
<div class="viewcode-block" id="CONCEPTUALIZER.initialize"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPTUALIZER.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conceptualization</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - conceptualization (CONCEPTUALIZATION)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conceptualization</span> <span class="o">=</span> <span class="n">conceptualization</span>
    </div>
<div class="viewcode-block" id="CONCEPTUALIZER.update"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPTUALIZER.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SceneRep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_visual_WM&#39;</span><span class="p">)</span>
        <span class="n">cpt_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_concept_LTM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpt_schemas</span> <span class="ow">and</span> <span class="n">SceneRep</span><span class="p">:</span>
            <span class="n">cpt_insts</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conceptualize</span><span class="p">(</span><span class="n">SceneRep</span><span class="p">,</span> <span class="n">cpt_schemas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_semantic_WM&#39;</span><span class="p">,</span> <span class="n">cpt_insts</span><span class="p">)</span>
        
            <span class="c"># Set all SceneRep elements to new=False</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
                <span class="n">SceneRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s">&#39;new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">():</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="CONCEPTUALIZER.conceptualize"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPTUALIZER.conceptualize">[docs]</a>    <span class="k">def</span> <span class="nf">conceptualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SceneRep</span><span class="p">,</span> <span class="n">cpt_schemas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cpt_insts</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span> <span class="c"># First process the nodes.</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                <span class="n">per_name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;percept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">per_inst</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;per_inst&#39;</span><span class="p">]</span>
                <span class="n">cpt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conceptualization</span><span class="o">.</span><span class="n">conceptualize</span><span class="p">(</span><span class="n">per_name</span><span class="p">)</span>
                <span class="n">cpt_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">cpt_schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">cpt_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cpt_inst</span> <span class="o">=</span> <span class="n">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;per_inst&#39;</span><span class="p">:</span><span class="n">per_inst</span><span class="p">,</span> <span class="s">&#39;cpt_schema&#39;</span><span class="p">:</span><span class="n">cpt_schema</span><span class="p">})</span>
                <span class="n">cpt_inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="n">per_inst</span><span class="o">.</span><span class="n">activity</span><span class="p">)</span> <span class="c"># THIS MIGHT NEED TO BE PARAMETRIZED!!</span>
                <span class="n">per_inst</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpt_inst</span>
                <span class="n">cpt_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt_inst</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span> <span class="c"># Then the relations.</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                <span class="n">per_name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;percept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">per_inst</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;per_inst&#39;</span><span class="p">]</span>
                <span class="n">cpt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conceptualization</span><span class="o">.</span><span class="n">conceptualize</span><span class="p">(</span><span class="n">per_name</span><span class="p">)</span>
                <span class="n">cpt_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">cpt_schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">cpt_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cpt_inst</span> <span class="o">=</span> <span class="n">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;per_inst&#39;</span><span class="p">:</span><span class="n">per_inst</span><span class="p">,</span> <span class="s">&#39;cpt_schema&#39;</span><span class="p">:</span><span class="n">cpt_schema</span><span class="p">})</span>
                <span class="n">cpt_inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="n">per_inst</span><span class="o">.</span><span class="n">activity</span><span class="p">)</span> <span class="c"># THIS MIGHT NEED TO BE PARAMETRIZED!!</span>
                <span class="n">pFrom</span> <span class="o">=</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="s">&#39;per_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span>
                <span class="n">pTo</span> <span class="o">=</span> <span class="n">SceneRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s">&#39;per_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span>
                <span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pFrom</span>
                <span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pTo</span>
                <span class="n">cpt_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt_inst</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">cpt_insts</span>
</div></div>
<div class="viewcode-block" id="CONCEPT_LTM"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPT_LTM">[docs]</a><span class="k">class</span> <span class="nc">CONCEPT_LTM</span><span class="p">(</span><span class="n">LTM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Concept_LTM&#39;</span><span class="p">):</span>
        <span class="n">LTM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_conceptualizer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpt_knowledge</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_act</span> <span class="o">=</span> <span class="mi">1</span>
        
<div class="viewcode-block" id="CONCEPT_LTM.initialize"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPT_LTM.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_knowledge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initilize the state of the CONCEPTUAL LTM with cpt_schema based on the content of cpt_knowledge</span>
<span class="sd">       </span>
<span class="sd">        Args:</span>
<span class="sd">            - cpt_knowledge (CONCEPTUAL_KNOWLEDGE):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpt_knowledge</span> <span class="o">=</span> <span class="n">cpt_knowledge</span>
        
        <span class="n">entity</span> <span class="o">=</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">find_meaning</span><span class="p">(</span><span class="s">&#39;ENTITY&#39;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">find_meaning</span><span class="p">(</span><span class="s">&#39;ACTION&#39;</span><span class="p">)</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">find_meaning</span><span class="p">(</span><span class="s">&#39;PROPERTY&#39;</span><span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">find_meaning</span><span class="p">(</span><span class="s">&#39;RELATION&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">concepts</span><span class="p">():</span>
            <span class="n">new_schema</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;is_a&quot;</span><span class="p">):</span>
                <span class="n">new_schema</span> <span class="o">=</span> <span class="n">CPT_ENTITY_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_act</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;is_a&quot;</span><span class="p">):</span>
                <span class="n">new_schema</span> <span class="o">=</span> <span class="n">CPT_ACTION_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_act</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;is_a&quot;</span><span class="p">):</span>
                <span class="n">new_schema</span> <span class="o">=</span> <span class="n">CPT_PROPERTY_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_act</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cpt_knowledge</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">concept</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;is_a&quot;</span><span class="p">):</span>
                <span class="n">new_schema</span> <span class="o">=</span> <span class="n">CPT_RELATION_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_act</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: unknown concept type&quot;</span> <span class="o">%</span><span class="n">concept</span><span class="o">.</span><span class="n">meaning</span>
            
            <span class="k">if</span> <span class="n">new_schema</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">new_schema</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_conceptualizer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_semantic_WM&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="p">)</span>
        
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span>
<div class="viewcode-block" id="CONCEPT_LTM.get_info"><a class="viewcode-back" href="../code.html#language_schemas.CONCEPT_LTM.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CONCEPT_LTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;init_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_act</span>
        <span class="k">return</span> <span class="n">data</span>
        </div></div>
<div class="viewcode-block" id="SEMANTIC_WM"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM">[docs]</a><span class="k">class</span> <span class="nc">SEMANTIC_WM</span><span class="p">(</span><span class="n">WM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Semantic_WM&#39;</span><span class="p">):</span>
        <span class="n">WM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_conceptualizer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_concept_LTM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_cxn_retrieval_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_visual_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:</span><span class="mf">1000.0</span><span class="p">,</span> <span class="s">&#39;act_inf&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&#39;x0&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;noise_mean&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;noise_std&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coop_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;comp_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;prune_threshold&#39;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">,</span> <span class="s">&#39;confidence_threshold&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;coop_asymmetry&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;comp_asymmetry&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;P_comp&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;P_coop&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span> <span class="c"># C2 is not implemented in this WM.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span> <span class="c"># Uses networkx to easily handle graph structure.</span>
    
<div class="viewcode-block" id="SEMANTIC_WM.update"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="n">cpt_insts</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="n">cpt_insts1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_conceptualizer&#39;</span><span class="p">)</span>

        <span class="n">sem_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="n">cpt_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_concept_LTM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpt_schemas</span> <span class="ow">and</span> <span class="n">sem_frame</span><span class="p">:</span>
            <span class="n">cpt_insts2</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instantiate_cpts</span><span class="p">(</span><span class="n">sem_frame</span><span class="p">,</span> <span class="n">cpt_schemas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpt_insts2</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;produce&#39;</span><span class="p">:</span>
            <span class="n">cpt_insts</span> <span class="o">=</span> <span class="n">cpt_insts1</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;listen&#39;</span><span class="p">:</span>
            <span class="n">cpt_insts</span> <span class="o">=</span> <span class="n">cpt_insts2</span>
        
        <span class="k">if</span> <span class="n">cpt_insts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">cpt_insts</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="c"># Does not deal with updating already existing nodes. Need to add that.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_activations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_SemRep</span><span class="p">(</span><span class="n">cpt_insts</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        
        <span class="n">expressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expressed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">expressed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;expressed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    
        <span class="n">output_to_gram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gram_WM_P_ouput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">,</span> <span class="n">output_to_gram</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;produce&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_new_sem</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s">&#39;produce&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_control&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_unexpressed_sem</span><span class="p">())</span>
    </div>
<div class="viewcode-block" id="SEMANTIC_WM.instantiate_cpts"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.instantiate_cpts">[docs]</a>    <span class="k">def</span> <span class="nf">instantiate_cpts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SemFrame</span><span class="p">,</span> <span class="n">cpt_schemas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds SemRep based on the received SemFrame.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            - SemFrame (TP_SEMFRAME)</span>
<span class="sd">            - cpt_schemas ([CPT_SCHEMAS])</span>
<span class="sd">        </span>
<span class="sd">        NOTE: </span>
<span class="sd">            - Because I only used the SemFrame, there is 1: no notion of how to set the initial activity of the SemRep based on the constructions.</span>
<span class="sd">            - Also, because the SemFrame is derived from the eq_inst, it is not clear how I can define the SemRep covers of cxn_instances (or, the cxn_inst cover of the SemRep).</span>
<span class="sd">            - This, later on, should evolve into a function that should possibly find already existing nodes and, rather than creating new instances, generate the proper bindings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cpt_insts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">SemFrame</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">cpt_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">cpt_schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cpt_inst</span> <span class="o">=</span> <span class="n">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;cpt_schema&#39;</span><span class="p">:</span><span class="n">cpt_schema</span><span class="p">})</span>
            <span class="n">cpt_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt_inst</span><span class="p">)</span>
            <span class="n">name_table</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpt_inst</span>
        
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">SemFrame</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">cpt_schema</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">cpt_schemas</span> <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">edge</span><span class="o">.</span><span class="n">concept</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cpt_inst</span> <span class="o">=</span> <span class="n">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;cpt_schema&#39;</span><span class="p">:</span><span class="n">cpt_schema</span><span class="p">})</span>
            <span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_table</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">pFrom</span><span class="p">]</span>
            <span class="n">cpt_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_table</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">pTo</span><span class="p">]</span>
            <span class="n">cpt_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt_inst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cpt_insts</span>
            
    </div>
<div class="viewcode-block" id="SEMANTIC_WM.update_SemRep"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.update_SemRep">[docs]</a>    <span class="k">def</span> <span class="nf">update_SemRep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpt_insts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the SemRep: Adds the nodes and edges needed based on the receivd concept instances.</span>
<span class="sd">        </span>
<span class="sd">        NOTE:</span>
<span class="sd">            - Does not handle the case of concept instance updating.</span>
<span class="sd">            - SemRep carreies the instance and the concept. The concept field is redundant, but is useful in order to be able to define</span>
<span class="sd">            SemMatch between SemRep graph and SemFrames (graphs needs to have same data key).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cpt_insts</span><span class="p">:</span>
            <span class="c"># First process all the instances that are not relations.</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cpt_insts</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&#39;cpt_schema&#39;</span><span class="p">],</span> <span class="n">CPT_RELATION_SCHEMA</span><span class="p">))]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cpt_inst</span><span class="o">=</span><span class="n">inst</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expressed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="c"># Then add the relations</span>
            <span class="k">for</span> <span class="n">rel_inst</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cpt_insts</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&#39;cpt_schema&#39;</span><span class="p">],</span> <span class="n">CPT_RELATION_SCHEMA</span><span class="p">)]:</span>
                <span class="n">node_from</span> <span class="o">=</span> <span class="n">rel_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">node_to</span> <span class="o">=</span> <span class="n">rel_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node_from</span><span class="p">,</span> <span class="n">node_to</span><span class="p">,</span> <span class="n">cpt_inst</span><span class="o">=</span><span class="n">rel_inst</span><span class="p">,</span> <span class="n">concept</span><span class="o">=</span><span class="n">rel_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">],</span>  <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expressed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="SEMANTIC_WM.gram_WM_P_ouput"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.gram_WM_P_ouput">[docs]</a>    <span class="k">def</span> <span class="nf">gram_WM_P_ouput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the output to send to gram_WM_P.</span>
<span class="sd">        The signal sent to gram_WM_P contains the activation levels of the node instance that so far have not been expressed.</span>
<span class="sd">        </span>
<span class="sd">        NOTE:   </span>
<span class="sd">            - NEED TO EXTEND TO RELATIONS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;expressed&#39;</span><span class="p">]):</span>
                <span class="n">output</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">activity</span>
                
        <span class="k">return</span> <span class="n">output</span>
        
    </div>
<div class="viewcode-block" id="SEMANTIC_WM.has_new_sem"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.has_new_sem">[docs]</a>    <span class="k">def</span> <span class="nf">has_new_sem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if there is at least 1 new element in the SemRep. False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
        
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="SEMANTIC_WM.has_unexpressed_sem"><a class="viewcode-back" href="../code.html#language_schemas.SEMANTIC_WM.has_unexpressed_sem">[docs]</a>    <span class="k">def</span> <span class="nf">has_unexpressed_sem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if there is at least 1 unexpresed node in the SemRep. False otherwise.</span>
<span class="sd">        </span>
<span class="sd">        NOTE:   </span>
<span class="sd">            - NEED TO EXTEND TO RELATIONS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;expressed&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
        
        
    <span class="c">#######################</span>
    <span class="c">### DISPLAY METHODS ###</span>
    <span class="c">#######################</span></div>
    <span class="k">def</span> <span class="nf">show_SemRep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%.1f</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">activity</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">edge_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">),</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%.1f</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;concept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">meaning</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">activity</span><span class="p">))</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="p">)</span>  
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> state (t=</span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span> <span class="n">node_labels</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="n">edge_labels</span><span class="p">)</span>

<span class="c">###############</span>
<span class="c">### GRAMMAR ###</span></div>
<div class="viewcode-block" id="GRAMMATICAL_LTM"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_LTM">[docs]</a><span class="k">class</span> <span class="nc">GRAMMATICAL_LTM</span><span class="p">(</span><span class="n">LTM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Grammatical_LTM&#39;</span><span class="p">):</span>
        <span class="n">LTM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_cxn_retrieval_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_act</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c">#The initial activation value for cxn schema.</span>
    
<div class="viewcode-block" id="GRAMMATICAL_LTM.initialize"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_LTM.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initilize the state of the GRAMMATICAL LTM with cxn_schema based on the content of grammar.</span>
<span class="sd">        Args:</span>
<span class="sd">            - grammar (GRAMMAR): A TCG grammar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">grammar</span>
        <span class="k">for</span> <span class="n">cxn</span> <span class="ow">in</span> <span class="n">grammar</span><span class="o">.</span><span class="n">constructions</span><span class="p">:</span>
            <span class="n">preference</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cxn</span><span class="o">.</span><span class="n">preference</span><span class="p">:</span>
                <span class="n">preference</span> <span class="o">=</span> <span class="n">cxn</span><span class="o">.</span><span class="n">preference</span>
            <span class="n">new_cxn_schema</span> <span class="o">=</span> <span class="n">CXN_SCHEMA</span><span class="p">(</span><span class="n">cxn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_act</span><span class="o">*</span><span class="n">preference</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_schema</span><span class="p">(</span><span class="n">new_cxn_schema</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GRAMMATICAL_LTM.update"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_LTM.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemas</span><span class="p">)</span>
    
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span></div>
<div class="viewcode-block" id="GRAMMATICAL_LTM.get_info"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_LTM.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GRAMMATICAL_LTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;init_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_act</span>
        <span class="k">return</span> <span class="n">data</span>
        
<span class="c">####################</span>
<span class="c">### GRAMMAR PROD ###  </span></div></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P">[docs]</a><span class="k">class</span> <span class="nc">GRAMMATICAL_WM_P</span><span class="p">(</span><span class="n">WM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TO DO!!</span>
<span class="sd">    </span>
<span class="sd">        - I AM NOT USING CXN GROUPS!...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Grammatical_WM_P&#39;</span><span class="p">):</span>
        <span class="n">WM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_cxn_retrieval_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:</span><span class="mf">30.0</span><span class="p">,</span> <span class="s">&#39;act_inf&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&#39;x0&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;noise_mean&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;noise_std&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coop_weight&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;comp_weight&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="s">&#39;coop_asymmetry&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;comp_asymmetry&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;P_comp&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;P_coop&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;deact_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;prune_threshold&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span> <span class="s">&#39;confidence_threshold&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">,</span> <span class="s">&#39;sub_threshold_r&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">}</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;activation&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;sem_length&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;form_length&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;continuity&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
        
<div class="viewcode-block" id="GRAMMATICAL_WM_P.update"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sem_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span> <span class="c"># I need to tie the activity of the cxn_instances to that of the SemRep.</span>
        <span class="n">new_cxn_insts</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_cxn_retrieval_P&#39;</span><span class="p">)</span>
        <span class="n">ctrl_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="n">phon_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_cxn_insts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_insts</span><span class="p">(</span><span class="n">new_cxn_insts</span><span class="p">)</span>            
                
        <span class="bp">self</span><span class="o">.</span><span class="n">convey_sem_activations</span><span class="p">(</span><span class="n">sem_input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_activations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">ctrl_input</span> <span class="ow">and</span> <span class="n">ctrl_input</span><span class="p">[</span><span class="s">&#39;produce&#39;</span><span class="p">]:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">produce_form</span><span class="p">(</span><span class="n">sem_input</span><span class="p">,</span><span class="n">phon_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_phonological_WM_P&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s">&#39;phon_WM_output&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_semantic_WM&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s">&#39;sem_WM_output&#39;</span><span class="p">])</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.add_new_insts"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.add_new_insts">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_insts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_insts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            new_insts ([{&quot;cxn_inst&quot;:CXN_SCHEMA_INST, &quot;match_qual&quot;:FLOAT}]): List of construction instances to be added to grammatical working memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">new_insts</span><span class="p">:</span>
            <span class="n">match_qual</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="s">&quot;match_qual&quot;</span><span class="p">]</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="s">&quot;cxn_inst&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">activity</span>
            <span class="n">new_inst</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="s">&quot;cxn_inst&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">new_inst</span><span class="p">,</span> <span class="n">act</span><span class="o">*</span><span class="n">match_qual</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cooperate</span><span class="p">(</span><span class="n">new_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">(</span><span class="n">new_inst</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.convey_sem_activations"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.convey_sem_activations">[docs]</a>    <span class="k">def</span> <span class="nf">convey_sem_activations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sem_input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For now, a construction receives activations from semantic working memory if 1. It&#39;s semframe covers at least one semrep that has not yet been </span>
<span class="sd">        expressed. 2. The SemFrame node that covers is linked to a TP_PHON.</span>
<span class="sd">        This is more inclusive that only lexical items and should probably be replaced by:</span>
<span class="sd">            - 1. Create a specific set of lexical construction</span>
<span class="sd">            - 2. Define higher level consstruction which include lexical items as requiring to slot in the lexical construction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
            <span class="n">cover_nodes</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span>
            
            <span class="n">act</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sem_input</span><span class="p">:</span>
                <span class="n">inst_node</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cover_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="n">node</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span> <span class="c"># Instances covers the node through sf_node</span>
                <span class="k">if</span> <span class="n">inst_node</span><span class="p">:</span>
                    <span class="n">inst_form</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node2form</span><span class="p">(</span><span class="n">inst_node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst_form</span><span class="p">,</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_PHON</span><span class="p">):</span> <span class="c"># sf_node is linked to a TP_PHON form. (Lexicalization)</span>
                        <span class="n">act</span> <span class="o">+=</span> <span class="n">sem_input</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>              
            <span class="n">act</span> <span class="o">=</span> <span class="n">act</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">cover_nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">activation</span><span class="o">.</span><span class="n">E</span> <span class="o">+=</span> <span class="n">act</span>
    
<span class="c">#    def apply_pressure(self, pressure):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Applies pressure by ramping up C2</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        for link in [l for l in self.coop_links if l.weight != 0]: # Make sure not to reactivate old weights.</span>
<span class="c">#            link.update_weight(self.C2_params[&#39;coop_weight&#39;] + self.C2_params[&#39;coop_weight&#39;]*pressure)</span>
<span class="c">#        for link in self.comp_links:</span>
<span class="c">#            link.update_weight(self.C2_params[&#39;comp_weight&#39;] + self.C2_params[&#39;comp_weight&#39;]*pressure)</span>
</div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.produce_form"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.produce_form">[docs]</a>    <span class="k">def</span> <span class="nf">produce_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sem_input</span><span class="p">,</span> <span class="n">phon_input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: </span>
<span class="sd">            - There is an issue with the fact that it takes 2 steps for the fact that part of the SemRep has been expressed gets</span>
<span class="sd">        registered by the semantic_WM. This leads to the repetition of the same assemblage twice.</span>
<span class="sd">        </span>
<span class="sd">            - Need to clarify how the score_threshold is defined.</span>
<span class="sd">            - Note that the only reason I don&#39;t just take the 1 winner above threshold is because of the issue of having multipe none overlapping assemblages.</span>
<span class="sd">            Might want to revisit assemble.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;activation&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;confidence_threshold&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">phon_WM_output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sem_WM_output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">winner_assemblage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_winner_assemblage</span><span class="p">(</span><span class="n">assemblages</span><span class="p">,</span> <span class="n">sem_input</span><span class="p">,</span> <span class="n">phon_input</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">winner_assemblage</span> <span class="ow">and</span> <span class="n">winner_assemblage</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">score_threshold</span><span class="p">:</span>
                <span class="p">(</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">missing_info</span><span class="p">,</span> <span class="n">expressed</span><span class="p">,</span> <span class="n">eq_inst</span><span class="p">)</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">form_read_out</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
                <span class="n">phon_WM_output</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phon_form</span><span class="p">)</span>
                <span class="n">sem_WM_output</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expressed</span><span class="p">)</span>
                <span class="n">assemblages</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
            
                <span class="c"># Option1: Replace the assemblage by it&#39;s equivalent instance</span>
<span class="c">#                self.replace_assemblage(winner_assemblage)</span>
                
                <span class="c"># Option2: Dismantle the assemblage by removing all the coop_link it involves and setting all composing instances activatoins to confidence_threshold.</span>
<span class="c">#                self.dismantle_assemblage(winner_assemblage)</span>
                
                 <span class="c"># Option3: Removes coop links + adds the equivalent instance.</span>
<span class="c">#                self.dismantle_assemblage2(winner_assemblage)</span>
                
                <span class="c"># Option4: Keeps all the coop_links but bumps down the activation values of all the isntances that are part of the winner assemblage.</span>
<span class="c">#                self.reset_assemblage(winner_assemblage)</span>
                
                <span class="c">#Option5: Sets all the instances in the winner assembalge to subthreshold activation. Sets all the coop_weightsto 0. So f-link remains but inst participating in assemblage decay unless they are reused.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_prod_state</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assemblages</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
                        <span class="n">assemblage</span><span class="o">.</span><span class="n">update_activation</span><span class="p">()</span>
                    <span class="n">winner_assemblage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_winner_assemblage</span><span class="p">(</span><span class="n">assemblages</span><span class="p">,</span> <span class="n">sem_input</span><span class="p">,</span> <span class="n">phon_input</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">winner_assemblage</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="k">if</span> <span class="n">phon_WM_output</span> <span class="ow">and</span> <span class="n">sem_WM_output</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s">&#39;phon_WM_output&#39;</span><span class="p">:</span><span class="n">phon_WM_output</span><span class="p">,</span> <span class="s">&#39;sem_WM_output&#39;</span><span class="p">:</span><span class="n">sem_WM_output</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.get_winner_assemblage"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.get_winner_assemblage">[docs]</a>    <span class="k">def</span> <span class="nf">get_winner_assemblage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assemblages</span><span class="p">,</span> <span class="n">sem_input</span><span class="p">,</span> <span class="n">phon_input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the winner assemblages and their equivalent instances.</span>
<span class="sd">        Args: </span>
<span class="sd">            - assemblages ([ASSEMBLAGE])</span>
<span class="sd">        </span>
<span class="sd">        Note: Need to discuss the criteria that come into play in choosing the winner assemblages.</span>
<span class="sd">        As for the SemRep covered weight, the constructions should receive activation from the SemRep instances. This could help directly factoring in the SemRep covered factor.</span>
<span class="sd">        The formula is biased by the fact that not all variables have the same range. This needs to be accounted for.   </span>
<span class="sd">        </span>
<span class="sd">        NOTE: </span>
<span class="sd">             -NEED TO SOMEHOW ACCOUNT FOR WETHER OR NOT THE ASSEMBLAGE EXPRESSES NOVEL INFORMATION. Otherwise, I get the situation in which assemblage get reused</span>
<span class="sd">        because they are boosted by new construction while scoring higher that the novel assemblages.</span>
<span class="sd">             - I need to include relations, not just nodes.</span>
<span class="sd">             </span>
<span class="sd">        Note:</span>
<span class="sd">            - For the continuity, this requires an access to what was posted to phonWM. Cannot be done simply by reactivating assemblages, at least</span>
<span class="sd">            in their current form, since they could be expanded by adding elements that would change the order of phons.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;activation&#39;</span><span class="p">]</span> <span class="c"># Activation weight</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">]</span> <span class="c"># SemRep covered weight</span>
        <span class="n">w3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]</span> <span class="c"># SynForm length weight  </span>
        <span class="n">w4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_params</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]</span> <span class="c"># Utterance continuity weight  </span>
        <span class="n">winner</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sem_length&#39;</span><span class="p">:[],</span> <span class="s">&#39;form_length&#39;</span><span class="p">:[],</span> <span class="s">&#39;utterance_continuity&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;continuity&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;eq_insts&#39;</span><span class="p">:[]}</span>
            
        <span class="c"># Computing the equivalent instance for each assemblage.</span>
        <span class="c"># For each assemblage stores the values of relevant scores.</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
<span class="c">#            eq_inst = self.assemblage2inst(assemblage)</span>
            <span class="p">(</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">missing_info</span><span class="p">,</span> <span class="n">expressed</span><span class="p">,</span> <span class="n">eq_inst</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_read_out</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span> <span class="c"># In order to test for continuity, I have to read_out every assemblage.</span>
            <span class="n">sem_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">sf_node</span> <span class="k">for</span> <span class="n">sf_node</span> <span class="ow">in</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SemFrame</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">][</span><span class="n">sf_node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sem_input</span><span class="p">])</span>
            <span class="n">form_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phon_form</span><span class="p">)</span>         
            <span class="n">continuity</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phon_form</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phon_input</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">phon_form</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">phon_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">:]:</span>
                    <span class="n">continuity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phon_form</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                    
            
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sem_length</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">form_length</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">continuity</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;eq_insts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq_inst</span><span class="p">)</span>
            
        <span class="c"># Normalize the scores</span>
        <span class="n">max_sem_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">])</span>
        <span class="n">max_form_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">])</span>
        <span class="n">max_continuity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">max_sem_length</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c"># Doesn&#39;t return anything if the assemblage doesn&#39;t cover unexpressed info.</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="n">max_sem_length</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">max_form_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="n">max_form_length</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">max_continuity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">/</span><span class="n">max_continuity</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">]]</span>
        
        <span class="n">max_score</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assemblages</span><span class="p">)):</span>
<span class="c">#            print &quot;t:%i - %f, %f, %f, %f&quot; % (self.t, assemblages[i].activation,  scores[&#39;sem_length&#39;][i], (1-scores[&#39;form_length&#39;][i]), scores[&#39;continuity&#39;][i])</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">assemblages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">activation</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;sem_length&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">w3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;form_length&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">w4</span><span class="o">*</span><span class="n">scores</span><span class="p">[</span><span class="s">&#39;continuity&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">assemblages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">max_score</span><span class="p">):</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">assemblages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">&gt;</span><span class="n">max_score</span><span class="p">:</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">assemblages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">winner</span>
 
<span class="c">#    def replace_assemblage(self, assemblage):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Replace all the construction instances contained in the assemblage by the assemblage equivalent cxn_inst.</span>
<span class="c">#        Args:</span>
<span class="c">#            - assemblage (ASSEMBLAGE)</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        eq_inst = GRAMMATICAL_WM_P.assemblage2inst(assemblage)</span>
<span class="c">#        # Sets the activation below confidence threshold so that it is not re-used right away. </span>
<span class="c">#        eq_inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;])</span>
<span class="c">#        for inst in assemblage.schema_insts:</span>
<span class="c">#            inst.alive = False</span>
<span class="c">#        self.add_new_insts([{&quot;cxn_inst&quot;:eq_inst, &quot;match_qual&quot;:1}])</span>
<span class="c">#        self.prune() # All the instances in the assemblage as well as all the f-links invovling them are removed.</span>
<span class="c">#    </span>
<span class="c">#    def dismantle_assemblage(self, assemblage):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Removes all the cooperation links involving instances that are part of the assemblages. Sets the activation of all the instances </span>
<span class="c">#        that are part of the assemblage to confidence_threshold.</span>
<span class="c">#        Args:</span>
<span class="c">#            - assemblage (ASSEMBLAGE)</span>
<span class="c">#            </span>
<span class="c">#        PB: When an assemblage is dismantled, some combinations of cxn instances might be necessary later on, but won&#39;t be possible to reconstruct.</span>
<span class="c">#        E.g. &quot;A man&quot; once used will never be rebuilt since it will not involve novel semantic material.</span>
<span class="c">#        The replace_assemblage policy would somewhat take care of this by including the equivalent instance. Same with dismantle assemblage2.</span>
<span class="c">#        However, there is still an issue with removing the cooperation links. For example,&quot; There is a woman who is pretty&quot; Then the system cannot utter,</span>
<span class="c">#        given more semantic info, &quot;A woman kicks a man&quot; since it cannot rebuild &quot;a woman&quot; since this was dismantled following the previous utterance.</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        self.remove_coop_links(inst_from=assemblage.schema_insts, inst_to=assemblage.schema_insts)</span>
<span class="c">#        for inst in assemblage.schema_insts:</span>
<span class="c">#            inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;])</span>
<span class="c">#    </span>
<span class="c">#    def dismantle_assemblage2(self, assemblage):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Removes all the cooperation links involving instances that are part of the assemblages. Sets the activation of all the instances </span>
<span class="c">#        that are part of the assemblage to confidence_threshold.</span>
<span class="c">#        Adds the assemblage equivalent cxn instance to the working memory.</span>
<span class="c">#        Args:</span>
<span class="c">#            - assemblage (ASSEMBLAGE)</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        eq_inst = GRAMMATICAL_WM_P.assemblage2inst(assemblage)</span>
<span class="c">#        # Sets the activation below confidence threshold so that it is not re-used right away. </span>
<span class="c">#        eq_inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;])</span>
<span class="c">#        </span>
<span class="c">#        self.remove_coop_links(inst_from=assemblage.schema_insts, inst_to=assemblage.schema_insts)</span>
<span class="c">#        for inst in assemblage.schema_insts:</span>
<span class="c">#            inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;])</span>
<span class="c">#        </span>
<span class="c">#        self.add_new_insts([{&quot;cxn_inst&quot;:eq_inst, &quot;match_qual&quot;:1}])</span>
<span class="c">#    </span>
<span class="c">#    def reset_assemblage(self, assemblage):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Resets the activation of all the instances that are part of the assemblage below confidence threshold.</span>
<span class="c">#        Adds the assemblage equivalent cxn instance to the working memory.</span>
<span class="c">#        Args:</span>
<span class="c">#            - assemblage (ASSEMBLAGE)</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        r = 0.9</span>
<span class="c">#        eq_inst = GRAMMATICAL_WM_P.assemblage2inst(assemblage)</span>
<span class="c">#        # Sets the activation below confidence threshold so that it is not re-used right away. </span>
<span class="c">#        eq_inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;]*r)</span>
<span class="c">#</span>
<span class="c">#        for inst in assemblage.schema_insts:</span>
<span class="c">#            inst.set_activation(self.C2_params[&#39;confidence_threshold&#39;]*r)</span>
<span class="c">#        </span>
<span class="c">#        self.add_new_insts([{&quot;cxn_inst&quot;:eq_inst, &quot;match_qual&quot;:1}])</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.post_prod_state"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.post_prod_state">[docs]</a>    <span class="k">def</span> <span class="nf">post_prod_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">winner_assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the grammatical state after production given a winner assemblage.</span>
<span class="sd">        If I use the option to not produce a winner if no assemblage covers any new SemRep nodes, don&#39;t need to set_subthreshold.</span>
<span class="sd">        Except for the fact that if I don&#39;t there is repetition due to the lag between production of assemblage and registering in semWM that some elements have been expressed.</span>
<span class="sd">        In the new version where winner assemblages are read recursively until  there are no more winners, I need to use set_subthreshold, otherwise the same winner will be picke again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_subthreshold</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_winners</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_coop_weigts</span><span class="p">()</span>
<span class="c">#        self.deactivate_coop_weigts2(winner_assemblage)</span>
        </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.set_subthreshold"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.set_subthreshold">[docs]</a>    <span class="k">def</span> <span class="nf">set_subthreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the activation of all the instances in insts to r*confidence_threshold where r= self.C2_paramss[&#39;sub_threshold_r&#39;]</span>
<span class="sd">        Args:</span>
<span class="sd">            - insts ([CXN_INST])</span>
<span class="sd">        NOTE:</span>
<span class="sd">            If the score of the assemblage is not just the avereage cxn inst activation, the value needs to be place low enough</span>
<span class="sd">            so that the system does not repeat the same utterance twice. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;sub_threshold_r&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;confidence_threshold&#39;</span><span class="p">])</span>
            </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.deactivate_coop_weigts"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.deactivate_coop_weigts">[docs]</a>    <span class="k">def</span> <span class="nf">deactivate_coop_weigts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets all the coop_links to weight = self.C2_params[&#39;deact_weight&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">coop_link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coop_links</span><span class="p">:</span>
            <span class="n">coop_link</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;deact_weight&#39;</span><span class="p">]</span>
                </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.deactivate_coop_weigts2"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.deactivate_coop_weigts2">[docs]</a>    <span class="k">def</span> <span class="nf">deactivate_coop_weigts2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assemblage</span><span class="p">,</span> <span class="n">deact_weight</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets all the coop_links that are associated with an instance in assemblage to weight = deact_weight</span>
<span class="sd">        Args:</span>
<span class="sd">            - assemblage (ASSEMBLAGE)</span>
<span class="sd">            - deact_weight (FLOAT)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">coop_link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coop_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coop_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">coop_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">):</span>
                <span class="n">coop_link</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">deact_weight</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.set_winners"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.set_winners">[docs]</a>    <span class="k">def</span> <span class="nf">set_winners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">winner_assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kills all the instances that are in competition with an instances that has been chosen in a winner assemblage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">winner_insts</span> <span class="o">=</span> <span class="n">winner_assemblage</span><span class="o">.</span><span class="n">schema_insts</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">inst_from</span> <span class="ow">in</span> <span class="n">winner_insts</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">inst_to</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">inst_to</span> <span class="ow">in</span> <span class="n">winner_insts</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">inst_from</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>

    <span class="c">###############################</span>
    <span class="c">### cooperative computation ###</span>
    <span class="c">###############################</span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.cooperate"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.cooperate">[docs]</a>    <span class="k">def</span> <span class="nf">cooperate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_inst</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">for</span> <span class="n">old_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">new_inst</span> <span class="o">!=</span> <span class="n">old_inst</span><span class="p">:</span>
               <span class="n">match</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">new_inst</span><span class="p">,</span> <span class="n">old_inst</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;match_cat&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                   <span class="k">for</span> <span class="n">match_qual</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;links&quot;</span><span class="p">]:</span>
                       <span class="k">if</span> <span class="n">match_qual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">add_coop_link</span><span class="p">(</span><span class="n">inst_from</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;inst_from&quot;</span><span class="p">],</span> <span class="n">port_from</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;port_from&quot;</span><span class="p">],</span> <span class="n">inst_to</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;inst_to&quot;</span><span class="p">],</span> <span class="n">port_to</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;port_to&quot;</span><span class="p">],</span> <span class="n">qual</span><span class="o">=</span><span class="n">match_qual</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.compete"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.compete">[docs]</a>    <span class="k">def</span> <span class="nf">compete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">old_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">new_inst</span> <span class="o">!=</span> <span class="n">old_inst</span><span class="p">:</span>
               <span class="n">match</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">new_inst</span><span class="p">,</span> <span class="n">old_inst</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;match_cat&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">add_comp_link</span><span class="p">(</span><span class="n">inst_from</span><span class="o">=</span><span class="n">new_inst</span><span class="p">,</span> <span class="n">inst_to</span><span class="o">=</span><span class="n">old_inst</span><span class="p">)</span>
        
<span class="c">#        # Possible addition...</span>
<span class="c">#        # Construction that correspond to 2 different hypotheses regarding which slot the new isnt should link to compete. </span>
<span class="c">#        # This is might be problematic. See my notes in notebook.</span>
<span class="c">#        for inst1 in self.schema_insts:</span>
<span class="c">#            for inst2 in self.schema_insts:</span>
<span class="c">#                if inst1 != inst2:</span>
<span class="c">#                    link1 = [l for l in self.coop_links if (l.inst_from == new_inst) and (l.inst_to == inst1)]</span>
<span class="c">#                    link2 = [l for l in self.coop_links if (l.inst_from == new_inst) and (l.inst_to == inst2)]</span>
<span class="c">#                    if link1 and link2:</span>
<span class="c">#                        self.add_comp_link(inst_from=inst1, inst_to=inst2)</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.overlap"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.overlap">[docs]</a>    <span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the set of SemRep nodes and edges on which inst1 and inst2 overlaps.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            - inst1 (CXN_SCHEMA_INST): A cxn instance</span>
<span class="sd">            - inst2 (CXN_SCHEMA_INST): A cxn instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">overlap</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inst1</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inst2</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;nodes&quot;</span><span class="p">]]</span>
        <span class="n">overlap</span><span class="p">[</span><span class="s">&quot;edges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">inst1</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;edges&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">inst2</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;edges&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">overlap</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">overlap</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">overlap</span>
        </div>
    <span class="nd">@staticmethod</span>    
<div class="viewcode-block" id="GRAMMATICAL_WM_P.link"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.link">[docs]</a>    <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">inst_p</span><span class="p">,</span> <span class="n">inst_c</span><span class="p">,</span> <span class="n">SR_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - inst_p (CXN_SCHEMA_INST): A cxn instance (parent)</span>
<span class="sd">            - inst_c (CXN_SCHEMA_INST): A cxn instance (child)</span>
<span class="sd">            - SR_node (): SemRep node on which both instances overlap</span>
<span class="sd">        NOTE:</span>
<span class="sd">            - NO LIGHT SEMANTICS!!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cxn_p</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">content</span>
        <span class="n">sf_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">cxn_p</span><span class="o">.</span><span class="n">find_elem</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">SR_node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Find SemFrame node that covers the SemRep node</span>
        <span class="n">cxn_c</span> <span class="o">=</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">content</span>
        <span class="n">sf_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">cxn_c</span><span class="o">.</span><span class="n">find_elem</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="n">SR_node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Find SemFrame node that covers the SemRep node</span>
        
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sf_p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">cxn_p</span><span class="o">.</span><span class="n">SymLinks</span><span class="o">.</span><span class="n">SL</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cxn_p</span><span class="o">.</span><span class="n">node2form</span><span class="p">(</span><span class="n">sf_p</span><span class="p">),</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_SLOT</span><span class="p">)</span> <span class="c"># sf_p is linked to a slot in cxn_p</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="n">sf_c</span><span class="o">.</span><span class="n">head</span> <span class="c"># sf_c is a head node</span>
        <span class="k">if</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span><span class="p">:</span>
            <span class="n">slot_p</span> <span class="o">=</span> <span class="n">cxn_p</span><span class="o">.</span><span class="n">node2form</span><span class="p">(</span><span class="n">sf_p</span><span class="p">)</span>
            <span class="n">cond3</span> <span class="o">=</span> <span class="n">cxn_c</span><span class="o">.</span><span class="n">clss</span> <span class="ow">in</span> <span class="n">slot_p</span><span class="o">.</span><span class="n">cxn_classes</span>
            <span class="c"># NEED TO ADD A LIGHT_SEM CONDITION (cond4?)</span>
            <span class="n">link</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;inst_from&quot;</span><span class="p">:</span> <span class="n">inst_c</span><span class="p">,</span> <span class="s">&quot;port_from&quot;</span><span class="p">:</span><span class="n">inst_c</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">),</span> <span class="s">&quot;inst_to&quot;</span><span class="p">:</span> <span class="n">inst_p</span><span class="p">,</span> <span class="s">&quot;port_to&quot;</span><span class="p">:</span><span class="n">inst_p</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="n">slot_p</span><span class="o">.</span><span class="n">order</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">cond3</span><span class="p">:</span>
                <span class="n">match_qual</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match_qual</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">match_qual</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.match"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        IMPORTANT NOTE: IT IS NOT CLEAR WHY THE ABSCENSE OF LINK SHOULD NECESSARILY MEAN COMPETITION....</span>
<span class="sd">            Think about the case of a lexical cxn LEX_CXN linking to a Det_CXN itself linking to a SVO_CXN, we don&#39;t want LEX_CXN to enter in competition with</span>
<span class="sd">            SVO_CXN, even though they can&#39;t link since the LEX_CXN doesn&#39;t match the class restriction of SVO_CXN (LEX_CXN is N, not NP).</span>
<span class="sd">        </span>
<span class="sd">        For now I set the case not(links) to match=0. This is incorrect, since it does not allow to handle properly the case of lexical competition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inst1</span> <span class="o">==</span> <span class="n">inst2</span><span class="p">:</span>
           <span class="n">match_cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># CHECK THAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">overlap</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">overlap</span><span class="p">):</span>
                <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">overlap</span><span class="p">[</span><span class="s">&quot;edges&quot;</span><span class="p">]:</span>
                <span class="n">match_cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">overlap</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">inst2</span><span class="p">,</span> <span class="n">inst1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">match_cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>      
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;match_cat&quot;</span><span class="p">:</span><span class="n">match_cat</span><span class="p">,</span> <span class="s">&quot;links&quot;</span><span class="p">:</span><span class="n">links</span><span class="p">}</span>
    
    <span class="c">##################</span>
    <span class="c">### Assemblage ###</span>
    <span class="c">##################    </span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.assemble"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.assemble">[docs]</a>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c"># THIS IS VERY DIFFERENT FROM THE ASSEMBLE ALGORITHM OF TCG 1.0</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WHAT ABOUT THE CASE WHERE THERE STILL IS COMPETITION GOING ON?</span>
<span class="sd">        </span>
<span class="sd">        NOTE THAT IN THE CASE OF MULTIPLE TREES GENERATED FROM THE SAME SET OF COOPERATION... THERE IS MAXIMUM SPANNING TREE. IS THIS IS THE ONE THAT SHOULD BE CONSIDERED?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_network</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">build_instance_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coop_links</span><span class="p">)</span>

        <span class="n">tops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inst_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst_network</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">n</span><span class="p">))]</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tops</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">frontier</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">assemblage</span> <span class="o">=</span> <span class="n">ASSEMBLAGE</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_trees</span><span class="p">(</span><span class="n">frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="p">,</span> <span class="n">inst_network</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
            <span class="n">assemblages</span> <span class="o">+=</span> <span class="n">results</span>
        
        <span class="c"># Compute assemblage activation values</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">assemblage</span><span class="o">.</span><span class="n">update_activation</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">assemblages</span>
        </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.build_instance_network"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.build_instance_network">[docs]</a>    <span class="k">def</span> <span class="nf">build_instance_network</span><span class="p">(</span><span class="n">schema_insts</span><span class="p">,</span> <span class="n">coop_links</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span> <span class="c"># This could be built incrementally.....</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">schema_insts</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;instance&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">inst</span><span class="o">.</span><span class="n">in_ports</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;port&quot;</span><span class="p">)</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;port2inst&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">coop_links</span><span class="p">:</span> <span class="c"># Does not requires the competition to be resolved (there could still be active competition links)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">inst_from</span><span class="p">,</span> <span class="n">link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;inst2port&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">graph</span>
</div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.get_trees"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.get_trees">[docs]</a>    <span class="k">def</span> <span class="nf">get_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursive function</span>
<span class="sd">        &quot;Un-superpose&quot; the trees!</span>

<span class="sd">        DOES NOT HANDLE THE CASE WHERE THERE STILL IS SOME COMPETITION GOING ON.</span>
<span class="sd">        NOTE: I think it does...</span>
<span class="sd">        ALSO, it returns sub-optimal trees. (Not only the tree that contains all the cooperating instances in the WM).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_frontiers</span> <span class="o">=</span> <span class="p">[[]]</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">frontier</span><span class="p">:</span>
            <span class="n">assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="n">assemblage</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">updated_frontiers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span>  <span class="n">child</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_coop_links</span><span class="p">(</span><span class="n">inst_from</span><span class="o">=</span><span class="p">[</span><span class="n">child</span><span class="p">],</span> <span class="n">inst_to</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">port_from</span><span class="o">=</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">)],</span> <span class="n">port_to</span><span class="o">=</span><span class="p">[</span><span class="n">port</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">new_frontiers</span><span class="p">:</span>
                            <span class="n">updated_frontiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">child</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
                <span class="n">new_frontiers</span> <span class="o">=</span> <span class="n">updated_frontiers</span>
        <span class="k">if</span> <span class="n">new_frontiers</span> <span class="o">==</span> <span class="p">[[]]:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_frontier</span> <span class="ow">in</span> <span class="n">new_frontiers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_trees</span><span class="p">(</span><span class="n">a_frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">graph</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
                </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.assemblage2inst"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.assemblage2inst">[docs]</a>    <span class="k">def</span> <span class="nf">assemblage2inst</span><span class="p">(</span><span class="n">assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">coop_links</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">coop_links</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">reduce_assemblage</span><span class="p">(</span><span class="n">new_assemblage</span><span class="p">,</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">coop_links</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span>
        <span class="n">eq_inst</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eq_inst</span><span class="o">.</span><span class="n">activity</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">activation</span>
        <span class="k">return</span> <span class="n">eq_inst</span>
      </div>
    <span class="nd">@staticmethod</span>      
<div class="viewcode-block" id="GRAMMATICAL_WM_P.reduce_assemblage"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.reduce_assemblage">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_assemblage</span><span class="p">(</span><span class="n">assemblage</span><span class="p">,</span> <span class="n">coop_link</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new, reduced, assemblage in which the instances cooperating (as defined by &#39;coop_link&#39;) have been combined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_p</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">inst_to</span>
        <span class="n">inst_c</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">inst_from</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span>
        
        <span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">,</span> <span class="n">port_corr</span><span class="p">)</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">combine_schemas</span><span class="p">(</span><span class="n">inst_p</span><span class="p">,</span> <span class="n">inst_c</span><span class="p">,</span> <span class="n">connect</span><span class="p">)</span>
        
        <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">ASSEMBLAGE</span><span class="p">()</span>
        <span class="n">new_assemblage</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">activation</span>
        
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inst</span> <span class="o">!=</span> <span class="n">inst_p</span> <span class="ow">and</span> <span class="n">inst</span> <span class="o">!=</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">)</span>
        
        <span class="n">coop_links</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">coop_links</span><span class="p">[:]</span>
        <span class="n">coop_links</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">coop_link</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">coop_link</span> <span class="ow">in</span> <span class="n">coop_links</span><span class="p">:</span>
            <span class="n">new_link</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">==</span> <span class="n">inst_p</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">==</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">==</span> <span class="n">inst_p</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">==</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span><span class="p">]</span>
            <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">new_link</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">new_assemblage</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.combine_schemas"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.combine_schemas">[docs]</a>    <span class="k">def</span> <span class="nf">combine_schemas</span><span class="p">(</span><span class="n">inst_to</span><span class="p">,</span> <span class="n">inst_from</span><span class="p">,</span> <span class="n">connect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new cxn_instance and the mapping between inst_to and inst_from ports to new_cxn_inst ports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_p</span> <span class="o">=</span> <span class="n">inst_to</span>
        <span class="n">port_p</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">port_to</span>
        <span class="n">cxn_p</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">content</span>
        <span class="n">slot_p</span> <span class="o">=</span> <span class="n">port_p</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">inst_c</span> <span class="o">=</span> <span class="n">inst_from</span>
        <span class="n">cxn_c</span> <span class="o">=</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">content</span>        
        
        <span class="p">(</span><span class="n">new_cxn</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">construction</span><span class="o">.</span><span class="n">CXN</span><span class="o">.</span><span class="n">unify</span><span class="p">(</span><span class="n">cxn_p</span><span class="p">,</span> <span class="n">slot_p</span><span class="p">,</span> <span class="n">cxn_c</span><span class="p">)</span>
        <span class="n">new_cxn_schema</span> <span class="o">=</span> <span class="n">CXN_SCHEMA</span><span class="p">(</span><span class="n">new_cxn</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c"># Define new_cxn trace</span>
        <span class="n">new_trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;semrep&#39;</span><span class="p">:{</span><span class="s">&#39;nodes&#39;</span><span class="p">:[],</span> <span class="s">&#39;edges&#39;</span><span class="p">:[]},</span> <span class="s">&quot;schemas&quot;</span><span class="p">:</span><span class="n">inst_p</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;schemas&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;schemas&quot;</span><span class="p">]}</span> 
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inst_p</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&#39;semrep&#39;</span><span class="p">][</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&#39;semrep&#39;</span><span class="p">][</span><span class="s">&#39;nodes&#39;</span><span class="p">]))</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inst_p</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;edges&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;semrep&quot;</span><span class="p">][</span><span class="s">&quot;edges&quot;</span><span class="p">]))</span>
        <span class="n">new_trace</span><span class="p">[</span><span class="s">&#39;semrep&#39;</span><span class="p">][</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="n">new_trace</span><span class="p">[</span><span class="s">&#39;semrep&#39;</span><span class="p">][</span><span class="s">&#39;edges&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">edges</span>
        
        <span class="c"># Defines new_cxn mapping</span>
        <span class="n">new_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;nodes&#39;</span><span class="p">:{},</span> <span class="s">&#39;edges&#39;</span><span class="p">:{}}</span> <span class="c"># TO DEFINE</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">new_mapping</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span><span class="c"># Check the parent node hasn&#39;t been removed.</span>
                <span class="n">new_mapping</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">][(</span><span class="n">c</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="o">=</span> <span class="n">v</span>
            
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">new_mapping</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">new_mapping</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">][(</span><span class="n">c</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">c</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="n">new_cxn_inst</span> <span class="o">=</span> <span class="n">CXN_SCHEMA_INST</span><span class="p">(</span><span class="n">new_cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">new_trace</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">new_mapping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c"># Define port correspondence</span>
        <span class="n">in_ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">in_ports</span> <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">slot_p</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">in_ports</span><span class="p">]</span>
        <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">set_ports</span><span class="p">()</span>
        
        <span class="n">port_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;in_ports&#39;</span><span class="p">:{},</span> <span class="s">&#39;out_ports&#39;</span><span class="p">:{}}</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">in_ports</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">new_port</span> <span class="ow">in</span> <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">in_ports</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_port</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_port</span>
                    <span class="k">break</span>
        <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">inst_p</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">)</span>
      
        <span class="k">return</span> <span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">,</span> <span class="n">port_corr</span><span class="p">)</span>
            
<span class="c">#    @staticmethod                </span>
<span class="c">#    def form_read_out_LR(assemblage):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Left2right reading of the tree formed byt the assemblage.</span>
<span class="c">#        </span>
<span class="c">#        NOTE: SHOULD BE REPLACED BY ASSEMBLE</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        def L2R_read(inst, graph, phon_form):</span>
<span class="c">#            &quot;&quot;&quot;</span>
<span class="c">#            &quot;&quot;&quot;</span>
<span class="c">#            cxn = inst.content</span>
<span class="c">#            SynForm = cxn.SynForm.form</span>
<span class="c">#            for f in SynForm:</span>
<span class="c">#                if isinstance(f, construction.TP_PHON):</span>
<span class="c">#                    phon_form.append(f.cxn_phonetics)</span>
<span class="c">#                else:</span>
<span class="c">#                    port = inst.find_port(f.order)</span>
<span class="c">#                    child  = graph.predecessors(port)</span>
<span class="c">#                    if not(child):</span>
<span class="c">#                        print &quot;MISSING INFORMATION!&quot;</span>
<span class="c">#                    else:</span>
<span class="c">#                        L2R_read(child[0], graph, phon_form)</span>
<span class="c">#        </span>
<span class="c">#        graph = GRAMMATICAL_WM_P.build_instance_network(assemblage.schema_insts, assemblage.coop_links)</span>
<span class="c">#        tops = [n for n in graph.nodes() if not(graph.successors(n))]</span>
<span class="c">#        phon_form = []</span>
<span class="c">#        L2R_read(tops[0], graph, phon_form)</span>
<span class="c">#        return phon_form</span>
        </div>
    <span class="nd">@staticmethod</span> 
<div class="viewcode-block" id="GRAMMATICAL_WM_P.form_read_out"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.form_read_out">[docs]</a>    <span class="k">def</span> <span class="nf">form_read_out</span><span class="p">(</span><span class="n">assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the phonological from generated by an assemblage by building the equivalent CXN INSTANCE.</span>
<span class="sd">        Returns: (phon_form, missing_info, expressed) with:</span>
<span class="sd">            - phon_form = the longest consecutive TP_PHON sequence that can be uttered.</span>
<span class="sd">            - missing_info = pointer to the SemRep node associated with the first TP_SLOT encountered, represented the missing information.</span>
<span class="sd">            - expressed = the set of semrep nodes that the assemblage expresses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eq_inst</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">assemblage2inst</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span>
        <span class="n">expressed</span> <span class="o">=</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&#39;semrep&#39;</span><span class="p">][</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span>
        <span class="n">phon_form</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SynForm</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_PHON</span><span class="p">):</span>
                <span class="n">phon_form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cxn_phonetics</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">SemFrame_node</span> <span class="o">=</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SymLinks</span><span class="o">.</span><span class="n">form2node</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
                <span class="n">SemRep_node</span> <span class="o">=</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">][</span><span class="n">SemFrame_node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">missing_info</span> <span class="o">=</span> <span class="n">SemRep_node</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">missing_info</span><span class="p">)</span>
      
        <span class="k">return</span> <span class="p">(</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">missing_info</span><span class="p">,</span> <span class="n">expressed</span><span class="p">,</span> <span class="n">eq_inst</span><span class="p">)</span>
    
    <span class="c">#######################</span>
    <span class="c">### DISPLAY METHODS ###</span>
    <span class="c">#######################</span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.draw_assemblages"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.draw_assemblages">[docs]</a>    <span class="k">def</span> <span class="nf">draw_assemblages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Assemblage_</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">draw_assemblage</span><span class="p">(</span><span class="n">assemblage</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.draw_instance_network"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.draw_instance_network">[docs]</a>    <span class="k">def</span> <span class="nf">draw_instance_network</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;instance&#39;</span><span class="p">],</span> <span class="n">node_color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">node_shape</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">node_color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">node_shape</span><span class="o">=</span><span class="s">&#39;h&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;port2inst&#39;</span><span class="p">],</span> <span class="n">edge_color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;inst2port&#39;</span><span class="p">],</span> <span class="n">edge_color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">node_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">node_labels</span><span class="p">)</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_P.draw_assemblage"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_P.draw_assemblage">[docs]</a>    <span class="k">def</span> <span class="nf">draw_assemblage</span><span class="p">(</span><span class="n">assemblage</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">build_instance_network</span><span class="p">(</span><span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">,</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">coop_links</span><span class="p">)</span>
        <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">draw_instance_network</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
                  
</div></div>
<div class="viewcode-block" id="CXN_RETRIEVAL_P"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P">[docs]</a><span class="k">class</span> <span class="nc">CXN_RETRIEVAL_P</span><span class="p">(</span><span class="n">PROCEDURAL_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Cxn_retrieval_P&quot;</span><span class="p">):</span>
        <span class="n">PROCEDURAL_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_LTM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span> <span class="o">=</span> <span class="p">[]</span>
    
<div class="viewcode-block" id="CXN_RETRIEVAL_P.update"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SemRep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span>
        <span class="n">cxn_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_LTM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cxn_schemas</span> <span class="ow">and</span> <span class="n">SemRep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instantiate_cxns</span><span class="p">(</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schemas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="p">)</span>
            <span class="c"># Set all SemRep elements to new=False</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">SemRep</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
                <span class="n">SemRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s">&#39;new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">SemRep</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">():</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">SemRep</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span> <span class="o">=</span> <span class="p">[]</span>
    </div>
<div class="viewcode-block" id="CXN_RETRIEVAL_P.instantiate_cxns"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P.instantiate_cxns">[docs]</a>    <span class="k">def</span> <span class="nf">instantiate_cxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schemas</span><span class="p">,</span> <span class="n">WK</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cxn_schemas</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">cxn_schema</span> <span class="ow">in</span> <span class="n">cxn_schemas</span><span class="p">:</span>        
            <span class="n">sub_iso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemMatch_cat</span><span class="p">(</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a_sub_iso</span> <span class="ow">in</span> <span class="n">sub_iso</span><span class="p">:</span>
                <span class="n">match_qual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SemMatch_qual</span><span class="p">(</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">,</span> <span class="n">a_sub_iso</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;semrep&quot;</span><span class="p">:{</span><span class="s">&quot;nodes&quot;</span><span class="p">:</span><span class="n">a_sub_iso</span><span class="p">[</span><span class="s">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="s">&quot;edges&quot;</span><span class="p">:</span><span class="n">a_sub_iso</span><span class="p">[</span><span class="s">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()},</span> <span class="s">&quot;schemas&quot;</span><span class="p">:[</span><span class="n">cxn_schema</span><span class="p">]}</span>
                <span class="n">node_mapping</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">a_sub_iso</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
                <span class="n">edge_mapping</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">a_sub_iso</span><span class="p">[</span><span class="s">&#39;edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;nodes&#39;</span><span class="p">:</span><span class="n">node_mapping</span><span class="p">,</span> <span class="s">&#39;edges&#39;</span><span class="p">:</span><span class="n">edge_mapping</span><span class="p">}</span>                
                <span class="n">new_instance</span> <span class="o">=</span> <span class="n">CXN_SCHEMA_INST</span><span class="p">(</span><span class="n">cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&quot;cxn_inst&quot;</span><span class="p">:</span><span class="n">new_instance</span><span class="p">,</span> <span class="s">&quot;match_qual&quot;</span><span class="p">:</span><span class="n">match_qual</span><span class="p">})</span>
                    </div>
<div class="viewcode-block" id="CXN_RETRIEVAL_P.SemMatch_cat"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P.SemMatch_cat">[docs]</a>    <span class="k">def</span> <span class="nf">SemMatch_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        IMPORTANT ALGORITHM</span>
<span class="sd">        Computes the categorical matches (match/no match) -&gt; Returns the sub-graphs isomorphisms. This is the main filter for instantiation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SemFrame_graph</span> <span class="o">=</span> <span class="n">cxn_schema</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SemFrame</span><span class="o">.</span><span class="n">graph</span> 
            
        <span class="n">node_concept_match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">cpt1</span><span class="p">,</span><span class="n">cpt2</span><span class="p">:</span> <span class="n">cpt1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">cpt2</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;is_a&quot;</span><span class="p">)</span>
        <span class="n">edge_concept_match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">cpt1</span><span class="p">,</span><span class="n">cpt2</span><span class="p">:</span> <span class="n">cpt1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">cpt2</span><span class="p">,</span> <span class="n">match_type</span><span class="o">=</span><span class="s">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">TCG_graph</span><span class="o">.</span><span class="n">node_iso_match</span><span class="p">(</span><span class="s">&quot;concept&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">node_concept_match</span><span class="p">)</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">TCG_graph</span><span class="o">.</span><span class="n">edge_iso_match</span><span class="p">(</span><span class="s">&quot;concept&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">edge_concept_match</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">subgraph_filter</span><span class="p">(</span><span class="n">subgraph</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns True only if at least one node or edge is tagged as new.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;new&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">sub_iso</span> <span class="o">=</span> <span class="n">TCG_graph</span><span class="o">.</span><span class="n">find_sub_iso</span><span class="p">(</span><span class="n">SemRep</span><span class="p">,</span> <span class="n">SemFrame_graph</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">nm</span><span class="p">,</span> <span class="n">edge_match</span><span class="o">=</span><span class="n">em</span><span class="p">,</span> <span class="n">subgraph_filter</span><span class="o">=</span><span class="n">subgraph_filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sub_iso</span>
    </div>
<div class="viewcode-block" id="CXN_RETRIEVAL_P.SemMatch_qual"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P.SemMatch_qual">[docs]</a>    <span class="k">def</span> <span class="nf">SemMatch_qual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SemRep</span><span class="p">,</span> <span class="n">cxn_schema</span><span class="p">,</span> <span class="n">a_sub_iso</span><span class="p">):</span> <span class="c">## NEEDS TO BE WRITTEN!! At this point the formalism does not support efficient quality of match.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the quality of match.</span>
<span class="sd">        Returns a value between 0 and 1: 0 -&gt; no match, 1 -&gt; perfect match.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: I NEED TO THINK ABOUT HOW TO INCORPORATE FOCUS ETC....</span>
<span class="sd">            - In the current version of focus, it only looks at the focus node for the quality of match. </span>
<span class="sd">                But focus should be defined as contrasts within consructions (and between constructions.)</span>
<span class="sd">                Move from focus as boolean value to focus as value attached to each node.</span>
<span class="sd">            - Still need to incorporate light sem. For this, need to switch to vector space representaiton of concept. </span>
<span class="sd">            This could be added on top of the is-a ontology.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Compute match qual value based on focus values.</span>
        <span class="n">focus_match</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">cxn_node</span><span class="p">,</span> <span class="n">sem_node_name</span> <span class="ow">in</span> <span class="n">a_sub_iso</span><span class="p">[</span><span class="s">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">sem_node_act</span> <span class="o">=</span> <span class="n">SemRep</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">sem_node_name</span><span class="p">][</span><span class="s">&#39;cpt_inst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">activity</span>
            <span class="k">if</span> <span class="n">cxn_node</span><span class="o">.</span><span class="n">focus</span><span class="p">:</span>
                <span class="n">focus</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">focus_match</span> <span class="o">-=</span> <span class="n">focus</span> <span class="o">-</span> <span class="n">sem_node_act</span> <span class="c"># This is much too simple. But placeholder for now.            </span>
        <span class="k">return</span> <span class="n">focus_match</span>
    
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span></div>
<div class="viewcode-block" id="CXN_RETRIEVAL_P.get_state"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_P.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CXN_RETRIEVAL_P</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;cnx_instances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>
</div></div>
<div class="viewcode-block" id="PHON_WM_P"><a class="viewcode-back" href="../code.html#language_schemas.PHON_WM_P">[docs]</a><span class="k">class</span> <span class="nc">PHON_WM_P</span><span class="p">(</span><span class="n">WM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Phonological_WM_P&#39;</span><span class="p">):</span>
        <span class="n">WM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_utter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;act_inf&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&#39;x0&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;noise_mean&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;noise_std&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coop_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;comp_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;prune_threshold&#39;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">,</span> <span class="s">&#39;confidence_threshold&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;coop_asymmetry&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;comp_asymmetry&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;P_comp&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;P_coop&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span> <span class="c"># C2 is not implemented in this WM.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span> <span class="o">=</span> <span class="p">[]</span>
    
<div class="viewcode-block" id="PHON_WM_P.update"><a class="viewcode-back" href="../code.html#language_schemas.PHON_WM_P.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phon_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phon_sequence</span><span class="p">:</span>
            <span class="n">new_phon_sequence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">phon_form</span> <span class="ow">in</span> <span class="n">phon_sequence</span><span class="p">:</span>
                <span class="n">phon_schema</span> <span class="o">=</span> <span class="n">PHON_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">word_form</span><span class="o">=</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                <span class="n">phon_inst</span> <span class="o">=</span> <span class="n">PHON_SCHEMA_INST</span><span class="p">(</span><span class="n">phon_schema</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;phon_schema&#39;</span><span class="p">:</span><span class="n">phon_schema</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
                <span class="n">new_phon_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_phon_sequence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_utter&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">phon_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;word_form&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">phon_inst</span> <span class="ow">in</span> <span class="n">new_phon_sequence</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_control&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_utter&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_activations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">phon_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;word_form&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">phon_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span><span class="p">])</span>
        
    
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span></div>
<div class="viewcode-block" id="PHON_WM_P.get_state"><a class="viewcode-back" href="../code.html#language_schemas.PHON_WM_P.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PHON_WM_P</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;phon_sequence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">phon_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;word_form&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">phon_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>
</div></div>
<div class="viewcode-block" id="UTTER"><a class="viewcode-back" href="../code.html#language_schemas.UTTER">[docs]</a><span class="k">class</span> <span class="nc">UTTER</span><span class="p">(</span><span class="n">PROCEDURAL_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Utter&#39;</span><span class="p">):</span>
        <span class="n">PROCEDURAL_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_output&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;speech_rate&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utterance_stack</span> <span class="o">=</span> <span class="p">[]</span>
    
<div class="viewcode-block" id="UTTER.update"><a class="viewcode-back" href="../code.html#language_schemas.UTTER.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_utterance</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utterance_stack</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;speech_rate&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">word_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utterance_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_output&#39;</span><span class="p">,</span> <span class="n">word_form</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_utterance</span><span class="p">:</span>
            <span class="n">new_utterance</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utterance_stack</span> <span class="o">=</span>  <span class="n">new_utterance</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utterance_stack</span>
            
<span class="c">####################</span>
<span class="c">### GRAMMAR COMP ###</span></div></div>
<div class="viewcode-block" id="PHON_WM_C"><a class="viewcode-back" href="../code.html#language_schemas.PHON_WM_C">[docs]</a><span class="k">class</span> <span class="nc">PHON_WM_C</span><span class="p">(</span><span class="n">WM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives input one word at a time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Phonological_WM_C&#39;</span><span class="p">):</span>
        <span class="n">WM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_input&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="s">&#39;act_inf&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&#39;x0&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;noise_mean&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;noise_std&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coop_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;comp_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;prune_threshold&#39;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">,</span> <span class="s">&#39;confidence_threshold&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;coop_asymmetry&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;comp_asymmetry&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;P_comp&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;P_coop&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span> <span class="c"># C2 is not implemented in this WM.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span> <span class="o">=</span> <span class="p">[]</span>

    
<div class="viewcode-block" id="PHON_WM_C.update"><a class="viewcode-back" href="../code.html#language_schemas.PHON_WM_C.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phon_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_input&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phon_form</span><span class="p">:</span>
            <span class="n">phon_schema</span> <span class="o">=</span> <span class="n">PHON_SCHEMA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">word_form</span><span class="o">=</span><span class="n">phon_form</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="n">phon_inst</span> <span class="o">=</span> <span class="n">PHON_SCHEMA_INST</span><span class="p">(</span><span class="n">phon_schema</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;phon_schema&#39;</span><span class="p">:</span><span class="n">phon_schema</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phon_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">,</span> <span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">,</span> <span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_control&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_activations</span><span class="p">()</span>     
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C">[docs]</a><span class="k">class</span> <span class="nc">GRAMMATICAL_WM_C</span><span class="p">(</span><span class="n">WM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Grammatical_WM_C&#39;</span><span class="p">):</span>
        <span class="n">WM</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_phonological_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_cxn_retrieval_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tau&#39;</span><span class="p">:</span><span class="mf">30.0</span><span class="p">,</span> <span class="s">&#39;act_inf&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s">&#39;x0&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;noise_mean&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;noise_std&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coop_weight&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;comp_weight&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="s">&#39;coop_asymmetry&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;comp_asymmetry&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;P_comp&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span> <span class="s">&#39;P_coop&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span>  <span class="s">&#39;deact_weight&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#39;prune_threshold&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span> <span class="s">&#39;confidence_threshold&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">,</span> <span class="s">&#39;sub_threshold_r&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">}</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;pred_init&#39;</span><span class="p">:[</span><span class="s">&#39;S&#39;</span><span class="p">]}</span>  <span class="c"># S is used to initialize the set of predictions. This is not not really in line with usage based... but for now I&#39;ll keep it this way.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_init</span> <span class="o">=</span> <span class="bp">None</span>
        
    
<div class="viewcode-block" id="GRAMMATICAL_WM_C.update"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTES:</span>
<span class="sd">            - NEED TO BE CAREFUL ABOUT THE TIME DELAY BETWEEN WM AND CXN RETRIEVAL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">listen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_control&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pred_init</span><span class="p">()</span>
        
        <span class="n">pred_cxn_insts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_cxn_retrieval_C&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pred_cxn_insts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">pred_cxn_insts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst</span><span class="o">.</span><span class="n">activity</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">()</span>   
        <span class="n">phon_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_phonological_WM_C&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phon_inst</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pred_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_activations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_links</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">produce_meaning</span><span class="p">()</span>
        
        </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.predictor"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.predictor">[docs]</a>    <span class="k">def</span> <span class="nf">predictor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TCG version of the Earley chart parsing predictor.</span>
<span class="sd">        </span>
<span class="sd">        NOTES: </span>
<span class="sd">            - Send all the classes of construction expected to cxn_retrieval. </span>
<span class="sd">            - The cxn_retrieval system will then send back the set of all possible predictions based instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_init</span><span class="p">:</span>
             <span class="n">pred_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_init</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">pred_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">has_predicted</span><span class="p">)]:</span>
                <span class="n">inst_pred</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">cxn_predictions</span><span class="p">()</span>
                <span class="n">pred_classes</span><span class="o">=</span> <span class="n">pred_classes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">inst_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pred_classes</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;covers&#39;</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">],</span> <span class="s">&#39;cxn_classes&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pred_classes</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_cxn_retrieval_C&#39;</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.scanner"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.scanner">[docs]</a>    <span class="k">def</span> <span class="nf">scanner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phon_inst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TCG version of the Earley chart parsing scanner.</span>
<span class="sd">        </span>
<span class="sd">        NOTES: </span>
<span class="sd">            - Check the existing instances whose form match the phon_inst.content[&#39;word_form&#39;]. If there is a match, move dot.</span>
<span class="sd">            - This is when the competitions are taking place.</span>
<span class="sd">            - Covers, to fit with production, should be a mapping between SynForm and PhonRep, while Trace is the part that only keeps track of the element that triggered the instantiation.</span>
<span class="sd">            - A key step is to reset the activation of the instance that is confirmed by an input to that of the Phon instance. Right now it is just set to the value of the phone instance. </span>
<span class="sd">            But it should be clamped to it or receive a constant input from it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matching_insts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
            <span class="n">phon_prediction</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">phon_prediction</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">phon_prediction</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phon_prediction</span> <span class="o">==</span> <span class="n">phon_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;word_form&#39;</span><span class="p">]:</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">phon_cover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phon_inst</span><span class="p">)</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">next_state</span><span class="p">()</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="n">phon_inst</span><span class="o">.</span><span class="n">activity</span><span class="p">)</span> <span class="c">#IMPORTANT STEP.</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
                    <span class="n">matching_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Here a cxn whose form is directly disproved by the input is directly removed. Need to revisit this deisgn choice.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">(</span><span class="n">matching_insts</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.completer"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.completer">[docs]</a>    <span class="k">def</span> <span class="nf">completer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TCG version of the Earley chart parsing completer.</span>
<span class="sd">        NOTES:</span>
<span class="sd">            -  Recursively check all the &quot;completed&quot; cxn (dot all the way to the right) and make the appropriate coop links.</span>
<span class="sd">            - I HAVE ADDED COMPETITION HERE... BUT I AM NOT SURE THAT THIS IS THE WAY TO GO.</span>
<span class="sd">                This has to be wrong in some way because their could be loops in the tree (think of an example), and in addition</span>
<span class="sd">                one wants to be able to maintain multiple possible predictions alive in terms of incomplete instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">completed_insts</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">form_state</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">completed_insts</span><span class="p">:</span>
            <span class="n">incomplete_insts</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span> <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">form_state</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">inst1</span> <span class="ow">in</span> <span class="n">completed_insts</span><span class="p">:</span>
                <span class="n">competing_insts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">inst2</span> <span class="ow">in</span> <span class="n">incomplete_insts</span><span class="p">:</span>
                    <span class="n">coop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooperate</span><span class="p">(</span><span class="n">inst2</span><span class="p">,</span> <span class="n">inst1</span><span class="p">)</span>   
                    <span class="k">if</span> <span class="n">coop</span><span class="p">:</span>
                        <span class="n">competing_insts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst2</span><span class="p">)</span>
                <span class="c"># Sets up competition between incompleted cxn that try to map onto the same compeleted cxn.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compete</span><span class="p">(</span><span class="n">competing_insts</span><span class="p">)</span>
               
            <span class="n">completed_insts</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">incomplete_insts</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">form_state</span><span class="p">)]</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.produce_meaning"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.produce_meaning">[docs]</a>    <span class="k">def</span> <span class="nf">produce_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">winner_assemblage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_winner_assemblage</span><span class="p">(</span><span class="n">assemblages</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">winner_assemblage</span><span class="o">.</span><span class="n">activation</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;confidence_threshold&#39;</span><span class="p">]:</span>
                <span class="n">sem_frame</span> <span class="o">=</span>  <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">meaning_read_out</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_semantic_WM&#39;</span><span class="p">,</span> <span class="n">sem_frame</span><span class="p">)</span>
                
                <span class="c">#Option5: Sets all the instances in the winner assembalge to subthreshold activation. Sets all the coop_weightsto 0. So f-link remains but inst participating in assemblage decay unless they are reused.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_prod_state</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="p">)</span>
    
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.get_winner_assemblage"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.get_winner_assemblage">[docs]</a>    <span class="k">def</span> <span class="nf">get_winner_assemblage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assemblages</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args: assemblages ([ASSEMBLAGE])</span>
<span class="sd">        Note: Need to discuss the criteria that come into play in choosing the winner assemblages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">max_score</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Computing the equivalent instance for each assemblage.</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">eq_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemblage2inst</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">activity</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">max_score</span><span class="p">):</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">assemblage</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">&gt;</span><span class="n">max_score</span><span class="p">:</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">winner</span> <span class="o">=</span> <span class="n">assemblage</span>
        <span class="k">return</span> <span class="n">winner</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.post_prod_state"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.post_prod_state">[docs]</a>    <span class="k">def</span> <span class="nf">post_prod_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">winner_assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the grammatical state after production given a winner assemblage.</span>
<span class="sd">        </span>
<span class="sd">        NOTE directly taken from the production model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_subthreshold</span><span class="p">(</span><span class="n">winner_assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_coop_weigts</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.set_subthreshold"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.set_subthreshold">[docs]</a>    <span class="k">def</span> <span class="nf">set_subthreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the activation of all the instances in insts to r*confidence_threshold where r= self.C2_paramss[&#39;sub_threshold_r&#39;]</span>
<span class="sd">        Args:</span>
<span class="sd">            - insts ([CXN_INST])</span>
<span class="sd">        </span>
<span class="sd">        NOTE: directly taken from the production model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;sub_threshold_r&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;confidence_threshold&#39;</span><span class="p">])</span>
            </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.deactivate_coop_weigts"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.deactivate_coop_weigts">[docs]</a>    <span class="k">def</span> <span class="nf">deactivate_coop_weigts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets all the coop_links to weight = self.C2_params[&#39;deact_weight&#39;]</span>
<span class="sd">        </span>
<span class="sd">        NOTE: directly taken from the production model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">coop_link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coop_links</span><span class="p">:</span>
            <span class="n">coop_link</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_params</span><span class="p">[</span><span class="s">&#39;deact_weight&#39;</span><span class="p">]</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.set_pred_init"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.set_pred_init">[docs]</a>    <span class="k">def</span> <span class="nf">set_pred_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the stack of TD initial predictions pred_init.</span>
<span class="sd">        The stacks is refilled as soon a state != 0.</span>
<span class="sd">        Reinitialize state to state == 0 will then trigger the init predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span><span class="p">[</span><span class="s">&#39;pred_init&#39;</span><span class="p">][:]</span>
    
    <span class="c">###############################</span>
    <span class="c">### cooperative computation ###</span>
    <span class="c">###############################</span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.cooperate"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.cooperate">[docs]</a>    <span class="k">def</span> <span class="nf">cooperate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       NOTE:</span>
<span class="sd">           - Check match between inst1 and inst2</span>
<span class="sd">           - If there is a match: create a coop link</span>
<span class="sd">           - Update inst1.covers[1] to self.state.</span>
<span class="sd">           - Compare to production, here C2 operations cannot simply be applied only once to new instances. this is due to the fact that the state of the instances changes. </span>
<span class="sd">           The state change is required by the fact that production includes predictions, predictions which are absent from production.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">match</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;match_cat&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">match_qual</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">match</span><span class="p">[</span><span class="s">&quot;links&quot;</span><span class="p">]:</span>
               <span class="k">if</span> <span class="n">match_qual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">add_coop_link</span><span class="p">(</span><span class="n">inst_from</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;inst_from&quot;</span><span class="p">],</span> <span class="n">port_from</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;port_from&quot;</span><span class="p">],</span> <span class="n">inst_to</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;inst_to&quot;</span><span class="p">],</span> <span class="n">port_to</span><span class="o">=</span><span class="n">link</span><span class="p">[</span><span class="s">&quot;port_to&quot;</span><span class="p">],</span> <span class="n">qual</span><span class="o">=</span><span class="n">match_qual</span><span class="p">)</span>
                   <span class="n">inst1</span><span class="o">.</span><span class="n">next_state</span><span class="p">()</span>
                   <span class="n">inst1</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
                   <span class="k">return</span> <span class="bp">True</span>
       <span class="k">return</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.compete"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.compete">[docs]</a>    <span class="k">def</span> <span class="nf">compete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">insts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds competition links between each pair of instances in comp_insts [CXN_SCHEMA_INST_C] for which self.match() returns -1.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            - comp_insts [CXN_SCHEMA_INST_C]:</span>
<span class="sd">            </span>
<span class="sd">        NOTE:</span>
<span class="sd">            - For now it is used in way that all the constructions in insts should be competing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">inst1</span> <span class="o">=</span> <span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">insts</span><span class="p">)):</span>
                <span class="n">inst2</span> <span class="o">=</span> <span class="n">insts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s">&#39;match_cat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_comp_link</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.overlap"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.overlap">[docs]</a>    <span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the set of PHON_SCHEMA_INST on which the instances overlap</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            - inst1 (CXN_SCHEMA_INST_C): A cxn instance</span>
<span class="sd">            - inst2 (CXN_SCHEMA_INST_C): A cxn instance</span>
<span class="sd">       </span>
<span class="sd">       NOTES:</span>
<span class="sd">            - Overlap shoudl define the set of constraints that are expressed by both constructions. It should allow to determine whether or not they</span>
<span class="sd">            compete or not.</span>
<span class="sd">            - I need to clean up the notion of trace and cover in both production and comprehension. In particular, it is important to note that a cxn can cover both semantic instances</span>
<span class="sd">            (SemRep) AND phon instances. The notion of trace changes also when cxn can be instantiated on the bases of predictions from other constructions. Should those constructions</span>
<span class="sd">            be part of the trace?</span>
<span class="sd">            - With respect to the previous point, in production, trace contains only pointers to what triggered the instantiation, covers contains a mappping!</span>
<span class="sd">            - Since we are dealing with CFG, one way to define overal, given the notion of covers (as [state1, state2]) can just be the intersection of two such segments, and the competition</span>
<span class="sd">            would occur as soon as the overlap is not null (no crossing branches in CFGs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">inst1</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inst1</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">inst2</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inst2</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">overlap</span>
    </div>
    <span class="nd">@staticmethod</span>    
<div class="viewcode-block" id="GRAMMATICAL_WM_C.link"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.link">[docs]</a>    <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">inst_p</span><span class="p">,</span> <span class="n">inst_c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            - inst_p (CXN_SCHEMA_INST_C): An incomplete cxn instance (parent)</span>
<span class="sd">            - inst_c (CXN_SCHEMA_INST_C): A completed cxn instance (child)</span>
<span class="sd">        NOTE:</span>
<span class="sd">            - Light semantics is required to limit for example the possibility of an intransitive verb to link into an SV cxn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cxn_c</span> <span class="o">=</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">content</span>
        <span class="n">form_elem_p</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">form_state</span>

        <span class="n">cond1</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form_elem_p</span><span class="p">,</span> <span class="n">construction</span><span class="o">.</span><span class="n">TP_SLOT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span>
            <span class="n">cond2</span> <span class="o">=</span> <span class="n">cxn_c</span><span class="o">.</span><span class="n">clss</span> <span class="ow">in</span> <span class="n">form_elem_p</span><span class="o">.</span><span class="n">cxn_classes</span>
            <span class="n">sem_elem_p</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">form2node</span><span class="p">(</span><span class="n">form_elem_p</span><span class="p">)</span>
            <span class="n">sem_elem_c</span> <span class="o">=</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SemFrame</span><span class="o">.</span><span class="n">get_head</span><span class="p">()</span>
            <span class="n">cond3</span> <span class="o">=</span> <span class="n">sem_elem_c</span><span class="o">.</span><span class="n">concept</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sem_elem_p</span><span class="o">.</span><span class="n">concept</span><span class="p">,</span> <span class="n">match_type</span> <span class="o">=</span> <span class="s">&quot;is_a&quot;</span><span class="p">)</span> <span class="c"># CHECK LIGHT_SEM MATCH. NEED TO HAVE QUALITATIVE MATCH (NOT BOOLEAN MATCH)</span>
                                
            <span class="n">link</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;inst_from&quot;</span><span class="p">:</span> <span class="n">inst_c</span><span class="p">,</span> <span class="s">&quot;port_from&quot;</span><span class="p">:</span><span class="n">inst_c</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">),</span> <span class="s">&quot;inst_to&quot;</span><span class="p">:</span> <span class="n">inst_p</span><span class="p">,</span> <span class="s">&quot;port_to&quot;</span><span class="p">:</span><span class="n">inst_p</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="n">form_elem_p</span><span class="o">.</span><span class="n">order</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">cond2</span> <span class="ow">and</span> <span class="n">cond3</span><span class="p">:</span>
                <span class="n">match_qual</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match_qual</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">match_qual</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.match"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Args:</span>
<span class="sd">            - inst1 (CXN_SCHEMA_INST_C): An incomplete cxn instance (parent)</span>
<span class="sd">            - inst2 (CXN_SCHEMA_INST_C): A completed cxn instance (child)</span>
<span class="sd">            </span>
<span class="sd">        NOTE:</span>
<span class="sd">            - Not sure that this method is really necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>            
        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inst1</span> <span class="o">==</span> <span class="n">inst2</span><span class="p">:</span>
           <span class="n">match_cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># CHECK THAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">overlap</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overlap</span><span class="p">:</span>
                <span class="n">match_cat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inst1</span><span class="o">.</span><span class="n">form_state</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst2</span><span class="o">.</span><span class="n">form_state</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inst1</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">inst2</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">inst1</span><span class="p">,</span> <span class="n">inst2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">inst2</span><span class="o">.</span><span class="n">form_state</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst1</span><span class="o">.</span><span class="n">form_state</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inst2</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">inst1</span><span class="o">.</span><span class="n">covers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">inst2</span><span class="p">,</span> <span class="n">inst1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">match_cat</span> <span class="o">=</span> <span class="mi">0</span>
                        
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;match_cat&quot;</span><span class="p">:</span><span class="n">match_cat</span><span class="p">,</span> <span class="s">&quot;links&quot;</span><span class="p">:</span><span class="n">links</span><span class="p">}</span>
    
    <span class="c">##################</span>
    <span class="c">### Assemblage ###</span>
    <span class="c">##################    </span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.assemble"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.assemble">[docs]</a>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WHAT ABOUT THE CASE WHERE THERE STILL IS COMPETITION GOING ON?</span>
<span class="sd">        </span>
<span class="sd">        NOTE THAT IN THE CASE OF MULTIPLE TREES GENERATED FROM THE SAME SET OF COOPERATION... THERE IS MAXIMUM SPANNING TREE. IS THIS IS THE ONE THA SHOULD BE CONSIDERED?</span>
<span class="sd">        </span>
<span class="sd">        NOTE: THIS IS COPIED FROM GRAMMATICAL_WM_P and uses methods from GRAMMATICAL_WM_P!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_network</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">build_instance_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coop_links</span><span class="p">)</span>

        <span class="n">tops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inst_network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">inst_network</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">n</span><span class="p">))]</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tops</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">frontier</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">assemblage</span> <span class="o">=</span> <span class="n">ASSEMBLAGE</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_trees</span><span class="p">(</span><span class="n">frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="p">,</span> <span class="n">inst_network</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
            <span class="n">assemblages</span> <span class="o">+=</span> <span class="n">results</span>
        
        <span class="c"># Compute assemblage activation values</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">assemblage</span><span class="o">.</span><span class="n">update_activation</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">assemblages</span>
        
</div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.get_trees"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.get_trees">[docs]</a>    <span class="k">def</span> <span class="nf">get_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursive function</span>
<span class="sd">        &quot;Un-superpose&quot; the trees!</span>

<span class="sd">        DOES NOT HANDLE THE CASE WHERE THERE STILL IS SOME COMPETITION GOING ON.</span>
<span class="sd">        NOTE: I think it does...</span>
<span class="sd">        ALSO, it returns sub-optimal trees. (Not only the tree that contains all the cooperating instances in the WM).</span>
<span class="sd">        </span>
<span class="sd">        NOTE: THIS IS COPIED FROM GRAMMATICAL_WM_P!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_frontiers</span> <span class="o">=</span> <span class="p">[[]]</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">frontier</span><span class="p">:</span>
            <span class="n">assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="n">assemblage</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">ports</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">updated_frontiers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span>  <span class="n">child</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_coop_links</span><span class="p">(</span><span class="n">inst_from</span><span class="o">=</span><span class="p">[</span><span class="n">child</span><span class="p">],</span> <span class="n">inst_to</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">port_from</span><span class="o">=</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">)],</span> <span class="n">port_to</span><span class="o">=</span><span class="p">[</span><span class="n">port</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">new_frontiers</span><span class="p">:</span>
                            <span class="n">updated_frontiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">child</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
                <span class="n">new_frontiers</span> <span class="o">=</span> <span class="n">updated_frontiers</span>
        <span class="k">if</span> <span class="n">new_frontiers</span> <span class="o">==</span> <span class="p">[[]]:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a_frontier</span> <span class="ow">in</span> <span class="n">new_frontiers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_trees</span><span class="p">(</span><span class="n">a_frontier</span><span class="p">,</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">graph</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.assemblage2inst"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.assemblage2inst">[docs]</a>    <span class="k">def</span> <span class="nf">assemblage2inst</span><span class="p">(</span><span class="n">assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE:</span>
<span class="sd">            - Same method as in production.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">coop_links</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">coop_links</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">reduce_assemblage</span><span class="p">(</span><span class="n">new_assemblage</span><span class="p">,</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">coop_links</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">coop_links</span>
        <span class="n">eq_inst</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eq_inst</span><span class="o">.</span><span class="n">activity</span> <span class="o">=</span> <span class="n">new_assemblage</span><span class="o">.</span><span class="n">activation</span>
        <span class="k">return</span> <span class="n">eq_inst</span>
      </div>
    <span class="nd">@staticmethod</span>      
<div class="viewcode-block" id="GRAMMATICAL_WM_C.reduce_assemblage"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.reduce_assemblage">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_assemblage</span><span class="p">(</span><span class="n">assemblage</span><span class="p">,</span> <span class="n">coop_link</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new, reduced, assemblage in which the instances cooperating (as defined by &#39;coop_link&#39;) have been combined.</span>
<span class="sd">        </span>
<span class="sd">        NOTE:</span>
<span class="sd">            - Same method as production.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_p</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">inst_to</span>
        <span class="n">inst_c</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">inst_from</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span>
        
        <span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">,</span> <span class="n">port_corr</span><span class="p">)</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">combine_schemas</span><span class="p">(</span><span class="n">inst_p</span><span class="p">,</span> <span class="n">inst_c</span><span class="p">,</span> <span class="n">connect</span><span class="p">)</span>
        
        <span class="n">new_assemblage</span> <span class="o">=</span> <span class="n">ASSEMBLAGE</span><span class="p">()</span>
        <span class="n">new_assemblage</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">activation</span>
        
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">schema_insts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inst</span> <span class="o">!=</span> <span class="n">inst_p</span> <span class="ow">and</span> <span class="n">inst</span> <span class="o">!=</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">)</span>
        
        <span class="n">coop_links</span> <span class="o">=</span> <span class="n">assemblage</span><span class="o">.</span><span class="n">coop_links</span><span class="p">[:]</span>
        <span class="n">coop_links</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">coop_link</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">coop_link</span> <span class="ow">in</span> <span class="n">coop_links</span><span class="p">:</span>
            <span class="n">new_link</span> <span class="o">=</span> <span class="n">coop_link</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">==</span> <span class="n">inst_p</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">==</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_to</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">==</span> <span class="n">inst_p</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_link</span><span class="o">.</span><span class="n">inst_from</span> <span class="o">==</span> <span class="n">inst_c</span><span class="p">:</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">inst_to</span> <span class="o">=</span> <span class="n">new_cxn_inst</span>
                <span class="n">new_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span> <span class="o">=</span> <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">coop_link</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">port_from</span><span class="p">]</span>
            <span class="n">new_assemblage</span><span class="o">.</span><span class="n">add_link</span><span class="p">(</span><span class="n">new_link</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">new_assemblage</span>
    </div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.combine_schemas"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.combine_schemas">[docs]</a>    <span class="k">def</span> <span class="nf">combine_schemas</span><span class="p">(</span><span class="n">inst_to</span><span class="p">,</span> <span class="n">inst_from</span><span class="p">,</span> <span class="n">connect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new cxn_instance and the mapping between inst_to and inst_from ports to new_cxn_inst ports.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: Only minor changes from the production method related to the difference in trace and mapping, phon_covers and covers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_p</span> <span class="o">=</span> <span class="n">inst_to</span>
        <span class="n">port_p</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">port_to</span>
        <span class="n">cxn_p</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">content</span>
        <span class="n">slot_p</span> <span class="o">=</span> <span class="n">port_p</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">inst_c</span> <span class="o">=</span> <span class="n">inst_from</span>
        <span class="n">cxn_c</span> <span class="o">=</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">content</span>        
        
        <span class="p">(</span><span class="n">new_cxn</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">construction</span><span class="o">.</span><span class="n">CXN</span><span class="o">.</span><span class="n">unify</span><span class="p">(</span><span class="n">cxn_p</span><span class="p">,</span> <span class="n">slot_p</span><span class="p">,</span> <span class="n">cxn_c</span><span class="p">)</span>
        <span class="n">new_cxn_schema</span> <span class="o">=</span> <span class="n">CXN_SCHEMA</span><span class="p">(</span><span class="n">new_cxn</span><span class="p">,</span> <span class="n">init_act</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c"># Define new_cxn trace</span>
        <span class="n">new_trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;schemas&quot;</span><span class="p">:</span><span class="n">inst_p</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;schemas&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s">&quot;schemas&quot;</span><span class="p">]}</span> 
        
        <span class="c"># Defines new_cxn mapping</span>
        <span class="n">new_mapping</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># TO DEFINE        </span>
        <span class="n">new_cxn_inst</span> <span class="o">=</span> <span class="n">CXN_SCHEMA_INST_C</span><span class="p">(</span><span class="n">new_cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">new_trace</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">new_mapping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">phon_cover</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">phon_cover</span> <span class="o">+</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">phon_cover</span>
        <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">covers</span> <span class="o">=</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">covers</span>
        
        <span class="c"># Define port correspondence</span>
        <span class="n">in_ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">inst_p</span><span class="o">.</span><span class="n">in_ports</span> <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="n">slot_p</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">inst_c</span><span class="o">.</span><span class="n">in_ports</span><span class="p">]</span>
        <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">set_ports</span><span class="p">()</span>
        
        <span class="n">port_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;in_ports&#39;</span><span class="p">:{},</span> <span class="s">&#39;out_ports&#39;</span><span class="p">:{}}</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">in_ports</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">new_port</span> <span class="ow">in</span> <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">in_ports</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_port</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;in_ports&#39;</span><span class="p">][</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_port</span>
                    <span class="k">break</span>
        <span class="n">port_corr</span><span class="p">[</span><span class="s">&#39;out_ports&#39;</span><span class="p">][</span><span class="n">inst_p</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_cxn_inst</span><span class="o">.</span><span class="n">find_port</span><span class="p">(</span><span class="s">&#39;output&#39;</span><span class="p">)</span>
      
        <span class="k">return</span> <span class="p">(</span><span class="n">new_cxn_inst</span><span class="p">,</span> <span class="n">port_corr</span><span class="p">)</span>
    </div>
    <span class="nd">@staticmethod</span> 
<div class="viewcode-block" id="GRAMMATICAL_WM_C.meaning_read_out"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.meaning_read_out">[docs]</a>    <span class="k">def</span> <span class="nf">meaning_read_out</span><span class="p">(</span><span class="n">assemblage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the semantic representation generated by an assemblage by building the equivalent CXN INSTANCE.</span>
<span class="sd">        Returns:</span>
<span class="sd">            - sem_frame = the SemFrame of the equivalent instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eq_inst</span> <span class="o">=</span> <span class="n">GRAMMATICAL_WM_C</span><span class="o">.</span><span class="n">assemblage2inst</span><span class="p">(</span><span class="n">assemblage</span><span class="p">)</span>
        <span class="n">sem_frame</span> <span class="o">=</span> <span class="n">eq_inst</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">SemFrame</span>      
        <span class="k">return</span> <span class="n">sem_frame</span>
    
    <span class="c">#######################</span>
    <span class="c">### DISPLAY METHODS ###</span>
    <span class="c">#######################</span></div>
<div class="viewcode-block" id="GRAMMATICAL_WM_C.draw_assemblages"><a class="viewcode-back" href="../code.html#language_schemas.GRAMMATICAL_WM_C.draw_assemblages">[docs]</a>    <span class="k">def</span> <span class="nf">draw_assemblages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: COPIED  FROM GRAMMATICAL_WM_P AND USE THE GRAMMATICAL_WM_P method!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assemblages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">assemblage</span> <span class="ow">in</span> <span class="n">assemblages</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Assemblage_</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">GRAMMATICAL_WM_P</span><span class="o">.</span><span class="n">draw_assemblage</span><span class="p">(</span><span class="n">assemblage</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        </div></div>
<div class="viewcode-block" id="CXN_RETRIEVAL_C"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_C">[docs]</a><span class="k">class</span> <span class="nc">CXN_RETRIEVAL_C</span><span class="p">(</span><span class="n">PROCEDURAL_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    THIS NEEDS TO ALLOW FOR THE IMPLEMENTATIN OF A FORM OF CHART PARSING.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Cxn_retrieval_C&quot;</span><span class="p">):</span>
        <span class="n">PROCEDURAL_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_LTM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_phonological_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span> <span class="o">=</span> <span class="p">[]</span>
    
<div class="viewcode-block" id="CXN_RETRIEVAL_C.update"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_C.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cxn_schemas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_LTM&#39;</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predictions</span> <span class="ow">and</span> <span class="n">cxn_schemas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instantiate_cxns</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">cxn_schemas</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span> <span class="o">=</span> <span class="p">[]</span>
                    </div>
<div class="viewcode-block" id="CXN_RETRIEVAL_C.instantiate_cxns"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_C.instantiate_cxns">[docs]</a>    <span class="k">def</span> <span class="nf">instantiate_cxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">cxn_schemas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">covers</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s">&#39;covers&#39;</span><span class="p">]</span>
        <span class="n">pred_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s">&#39;cxn_classes&#39;</span><span class="p">])</span>
        <span class="n">old_pred_classes</span> <span class="o">=</span> <span class="n">pred_classes</span>

        <span class="k">while</span> <span class="n">pred_classes</span><span class="p">:</span> <span class="c"># Recursively instantiate the constructions.</span>
            <span class="n">new_pred_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">cxn_schema</span> <span class="ow">in</span> <span class="n">cxn_schemas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cxn_schema</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">clss</span> <span class="ow">in</span> <span class="n">pred_classes</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;schemas&#39;</span><span class="p">:[</span><span class="n">cxn_schema</span><span class="p">]}</span>
                    <span class="n">cxn_inst</span> <span class="o">=</span> <span class="n">CXN_SCHEMA_INST_C</span><span class="p">(</span><span class="n">cxn_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{})</span>
                    <span class="n">cxn_inst</span><span class="o">.</span><span class="n">covers</span> <span class="o">=</span> <span class="n">covers</span><span class="p">[:]</span> <span class="c"># That&#39;s not really a good &quot;cover&quot;, cover should be a mapping between SynForm elements and PhonRep.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cxn_inst</span><span class="p">)</span>
                    <span class="c"># Recursively add the instances predicted by the newly instantiated cxns.</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="n">cxn_inst</span><span class="o">.</span><span class="n">cxn_predictions</span><span class="p">()</span>
                    <span class="n">new_pred_classes</span> <span class="o">=</span> <span class="n">new_pred_classes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pred</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_pred_classes</span><span class="p">]))</span>
            <span class="n">old_pred_classes</span> <span class="o">=</span> <span class="n">old_pred_classes</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">new_pred_classes</span><span class="p">)</span>
            <span class="n">pred_classes</span> <span class="o">=</span> <span class="n">new_pred_classes</span>
                        
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span></div>
<div class="viewcode-block" id="CXN_RETRIEVAL_C.get_state"><a class="viewcode-back" href="../code.html#language_schemas.CXN_RETRIEVAL_C.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CXN_RETRIEVAL_C</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;cnx_instances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inst</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cxn_instances</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>
        
<span class="c">####################</span>
<span class="c">### TASK CONTROL ###      </span></div></div>
<div class="viewcode-block" id="CONTROL"><a class="viewcode-back" href="../code.html#language_schemas.CONTROL">[docs]</a><span class="k">class</span> <span class="nc">CONTROL</span><span class="p">(</span><span class="n">PROCEDURAL_SCHEMA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This needs to be reformatted to better handle comprehension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Control&quot;</span><span class="p">):</span>
        <span class="n">PROCEDURAL_SCHEMA</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;IN&#39;</span><span class="p">,</span> <span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_semantic_WM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_port</span><span class="p">(</span><span class="s">&#39;OUT&#39;</span><span class="p">,</span> <span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time_pressure&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="s">&#39;start_produce&#39;</span><span class="p">:</span><span class="mi">1000</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;unexpressed_sem&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="s">&#39;mode&#39;</span><span class="p">:</span><span class="s">&#39;produce&#39;</span><span class="p">,</span> <span class="s">&#39;produce&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
    
<div class="viewcode-block" id="CONTROL.set_mode"><a class="viewcode-back" href="../code.html#language_schemas.CONTROL.set_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span><span class="s">&#39;produce&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;produce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;unexpressed_sem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">[</span><span class="s">&#39;start_produce&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
    </div>
<div class="viewcode-block" id="CONTROL.update"><a class="viewcode-back" href="../code.html#language_schemas.CONTROL.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Communicating with semantic_WM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_semantic_WM&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">])</span>
        
        <span class="c"># Communicating with grammatical_WM_P</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;produce&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_phonological_WM_P&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;unexpressed_sem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;from_semantic_WM&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">[</span><span class="s">&#39;start_produce&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">[</span><span class="s">&#39;start_produce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;unexpressed_sem&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;produce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;produce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">[</span><span class="s">&#39;start_produce&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;unexpressed_sem&#39;</span><span class="p">]):</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pressure</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;last_prod_time&#39;</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">[</span><span class="s">&#39;time_pressure&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="c">#Pressure ramps up linearly to 1</span>

            <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;produce&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;produce&#39;</span><span class="p">],</span> <span class="s">&#39;pressure&#39;</span><span class="p">:</span><span class="n">pressure</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_P&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                
        <span class="c"># Communicating with grammatical_WM_C</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;listen&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="s">&#39;to_grammatical_WM_C&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                
    <span class="c">####################</span>
    <span class="c">### JSON METHODS ###</span>
    <span class="c">####################</span></div>
<div class="viewcode-block" id="CONTROL.get_info"><a class="viewcode-back" href="../code.html#language_schemas.CONTROL.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;task_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span>
        <span class="k">return</span> <span class="n">data</span>
    </div>
<div class="viewcode-block" id="CONTROL.get_state"><a class="viewcode-back" href="../code.html#language_schemas.CONTROL.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="k">return</span> <span class="n">data</span>
        
<span class="c">#####################</span>
<span class="c">### EXTRA CLASSES ###         </span></div></div>
<div class="viewcode-block" id="TEXT2SPEECH"><a class="viewcode-back" href="../code.html#language_schemas.TEXT2SPEECH">[docs]</a><span class="k">class</span> <span class="nc">TEXT2SPEECH</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate_percent</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_percent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rate_percent</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utterance</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">pyttsx</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">engine_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">&#39;rate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">&#39;rate&#39;</span><span class="p">,</span> <span class="n">engine_rate</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_percent</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">utter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utterance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utterance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">runAndWait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">utterance</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="SEM_GENERATOR"><a class="viewcode-back" href="../code.html#language_schemas.SEM_GENERATOR">[docs]</a><span class="k">class</span> <span class="nc">SEM_GENERATOR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sem_inputs</span><span class="p">,</span> <span class="n">conceptLTM</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sem_inputs</span> <span class="o">=</span> <span class="n">sem_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conceptLTM</span> <span class="o">=</span> <span class="n">conceptLTM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">()</span>
    
<div class="viewcode-block" id="SEM_GENERATOR.preprocess_inputs"><a class="viewcode-back" href="../code.html#language_schemas.SEM_GENERATOR.preprocess_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sem_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sem_inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">sem_rate</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;sem_rate&#39;</span><span class="p">]</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;sequence&#39;</span><span class="p">]</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sem_rate</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">timing</span><span class="p">):</span>
                <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">sem_rate</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">))]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">sem_rate</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;PREPROCESSING ERROR: Provide either timing or rate for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="n">name</span>
                </div>
<div class="viewcode-block" id="SEM_GENERATOR.show_options"><a class="viewcode-back" href="../code.html#language_schemas.SEM_GENERATOR.show_options">[docs]</a>    <span class="k">def</span> <span class="nf">show_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sem_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sem_inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">print</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_input</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>   </div>
<div class="viewcode-block" id="SEM_GENERATOR.show_input"><a class="viewcode-back" href="../code.html#language_schemas.SEM_GENERATOR.show_input">[docs]</a>    <span class="k">def</span> <span class="nf">show_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sem_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sem_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sem_input</span><span class="p">:</span>
            <span class="n">propositions</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;propositions&#39;</span><span class="p">]</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;sequence&#39;</span><span class="p">]</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)):</span>
                <span class="k">print</span> <span class="s">&#39;t: </span><span class="si">%.1f</span><span class="s">, prop: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">timing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">propositions</span><span class="p">[</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
            </div>
<div class="viewcode-block" id="SEM_GENERATOR.sem_generator"><a class="viewcode-back" href="../code.html#language_schemas.SEM_GENERATOR.sem_generator">[docs]</a>    <span class="k">def</span> <span class="nf">sem_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a generator based on a semantic_data loaded by TCG_LOADER.load_sem_input().</span>
<span class="sd">        Eeach time next() function is called, returns a set of concept instances as well as the next time at which the generator should be called.</span>
<span class="sd">        Args:</span>
<span class="sd">            - sem_input: a semantic input dict loaded using load_sem_input()</span>
<span class="sd">            - conceptLTM (CONCEPT_LTM): Contains concept schemas.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c"># For reference.</span>
    <span class="c">#        func_pattern = r&quot;(?P&lt;operator&gt;\w+)\((?P&lt;args&gt;.*)\)&quot;</span>
    <span class="c">#        cpt_pattern = r&quot;[A-Z0-9_]+&quot;</span>
    <span class="c">#        var_pattern = r&quot;[a-z0-9]+&quot;</span>
    <span class="c">#        act_pattern = r&quot;[0-9]*\.[0-9]+|[0-9]+&quot;</span>
    <span class="c">#        cpt_var_pattern = r&quot;\?[A-Z0-9_]+&quot;</span>
        
        <span class="c"># More directly specialized pattern. Works since I limit myself to two types of expressions CONCEPT(var) or var1(var2, var3) (and ?CONCEPT(var))</span>
<span class="c">#        func_pattern_cpt = r&quot;(?P&lt;cpt_var&gt;\??)(?P&lt;operator&gt;[A-Z0-9_]+)\(\s*(?P&lt;var&gt;[a-z0-9]+)\s*\)&quot; # Concept definition (without activation)</span>
        <span class="n">func_pattern_cpt2</span> <span class="o">=</span> <span class="s">r&quot;(?P&lt;cpt_var&gt;\??)(?P&lt;operator&gt;[A-Z0-9_]+)\(\s*(?P&lt;var&gt;[a-z0-9]+)((\s*,\s*)(?P&lt;act&gt;[0-9]*\.[0-9]+|[0-9]+))?\s*\)&quot;</span> <span class="c"># Concept definition with activation</span>
        <span class="n">func_pattern_rel</span> <span class="o">=</span> <span class="s">r&quot;(?P&lt;operator&gt;[a-z0-9]+)\(\s*(?P&lt;var1&gt;[a-z0-9]+)(\s*,\s*)(?P&lt;var2&gt;[a-z0-9]+)\s*\)&quot;</span>
        
        <span class="n">sem_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sem_inputs</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
        <span class="n">propositions</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;propositions&#39;</span><span class="p">]</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;sequence&#39;</span><span class="p">]</span>
        <span class="n">timing</span> <span class="o">=</span> <span class="n">sem_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
        
        <span class="n">next_timing</span> <span class="o">=</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">([],</span> <span class="n">next_timing</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            
        <span class="n">name_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)):</span>          
            <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">prop_name</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">prop_list</span> <span class="o">=</span> <span class="n">propositions</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;sem_input &lt;- t: </span><span class="si">%.1f</span><span class="s">, prop: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">timing</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">propositions</span><span class="p">[</span><span class="n">sequence</span><span class="p">[</span><span class="n">idx</span><span class="p">]]))</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">prop_list</span><span class="p">:</span>
                <span class="c"># Case1:</span>
                <span class="n">match1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">func_pattern_cpt2</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
                <span class="n">match2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">func_pattern_rel</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match1</span><span class="p">:</span>
                    <span class="n">dat</span> <span class="o">=</span> <span class="n">match1</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="n">cpt_var</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;cpt_var&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span>
                    <span class="n">concept</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;operator&#39;</span><span class="p">]</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;var&#39;</span><span class="p">]</span>                        
                    <span class="n">cpt_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conceptLTM</span><span class="o">.</span><span class="n">find_schema</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">concept</span><span class="p">)</span>
                    <span class="n">cpt_act</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;act&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        
                    <span class="n">cpt_inst</span> <span class="o">=</span> <span class="n">CPT_SCHEMA_INST</span><span class="p">(</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;per_inst&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;cpt_schema&#39;</span><span class="p">:</span><span class="n">cpt_schema</span><span class="p">,</span> <span class="s">&#39;ref&#39;</span><span class="p">:</span><span class="n">var</span><span class="p">})</span> <span class="c"># &#39;ref&#39; is used to track referent.</span>
                    <span class="k">if</span> <span class="n">cpt_act</span><span class="p">:</span>
                        <span class="n">cpt_inst</span><span class="o">.</span><span class="n">set_activation</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cpt_act</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">cpt_var</span><span class="p">:</span>
                        <span class="n">cpt_inst</span><span class="o">.</span><span class="n">unbound</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">name_table</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpt_inst</span>
                    <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpt_inst</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">match2</span><span class="p">:</span>
                    <span class="n">dat</span> <span class="o">=</span> <span class="n">match2</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;operator&#39;</span><span class="p">]</span>
                    <span class="n">arg1</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;var1&#39;</span><span class="p">]</span>
                    <span class="n">arg2</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s">&#39;var2&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">rel</span> <span class="ow">in</span> <span class="n">name_table</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">arg1</span> <span class="ow">in</span> <span class="n">name_table</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">arg2</span> <span class="ow">in</span> <span class="n">name_table</span><span class="p">)):</span>
                        <span class="k">print</span> <span class="s">&quot;ERROR: variable used before it is defined.&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rel_inst</span> <span class="o">=</span> <span class="n">name_table</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span>
                        <span class="n">rel_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pFrom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_table</span><span class="p">[</span><span class="n">arg1</span><span class="p">]</span>
                        <span class="n">rel_inst</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s">&#39;pTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_table</span><span class="p">[</span><span class="n">arg2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;ERROR, unknown formula&quot;</span>
            
            <span class="n">next_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>       
            <span class="k">if</span> <span class="n">next_idx</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">timing</span><span class="p">):</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="n">timing</span><span class="p">[</span><span class="n">next_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="k">yield</span> <span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">next_time</span><span class="p">,</span> <span class="s">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prop_list</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="UTTER_GENERATOR"><a class="viewcode-back" href="../code.html#language_schemas.UTTER_GENERATOR">[docs]</a><span class="k">class</span> <span class="nc">UTTER_GENERATOR</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ling_inputs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ling_inputs</span> <span class="o">=</span> <span class="n">ling_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">()</span>
    
<div class="viewcode-block" id="UTTER_GENERATOR.preprocess_inputs"><a class="viewcode-back" href="../code.html#language_schemas.UTTER_GENERATOR.preprocess_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ling_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ling_inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">utter_rate</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;utter_rate&#39;</span><span class="p">]</span>
            <span class="n">utterance</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;utterance&#39;</span><span class="p">]</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">utter_rate</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">timing</span><span class="p">):</span>
                <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">utter_rate</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utterance</span><span class="p">))]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">utter_rate</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;PREPROCESSING ERROR: Provide either timing or rate for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="n">name</span>
    </div>
<div class="viewcode-block" id="UTTER_GENERATOR.show_options"><a class="viewcode-back" href="../code.html#language_schemas.UTTER_GENERATOR.show_options">[docs]</a>    <span class="k">def</span> <span class="nf">show_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ling_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ling_inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">print</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_input</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                </div>
<div class="viewcode-block" id="UTTER_GENERATOR.show_input"><a class="viewcode-back" href="../code.html#language_schemas.UTTER_GENERATOR.show_input">[docs]</a>    <span class="k">def</span> <span class="nf">show_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ling_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ling_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ling_input</span><span class="p">:</span>
            <span class="n">utterance</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;utterance&#39;</span><span class="p">]</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utterance</span><span class="p">)):</span>
                <span class="k">print</span> <span class="s">&#39;t: </span><span class="si">%.1f</span><span class="s">, word-form: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">timing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">utterance</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    </div>
<div class="viewcode-block" id="UTTER_GENERATOR.utter_generator"><a class="viewcode-back" href="../code.html#language_schemas.UTTER_GENERATOR.utter_generator">[docs]</a>    <span class="k">def</span> <span class="nf">utter_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a generator based on a linguistic_data loaded by TCG_LOADER.load_ling_input().</span>
<span class="sd">        Eeach time next() function is called, returns a word-form (STRING) as well as the next time at which the generator should be called.</span>
<span class="sd">        Args:</span>
<span class="sd">            - ling_input: a linguistic input dict loaded using load_ling_input()</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">ling_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ling_inputs</span><span class="p">[</span><span class="n">input_name</span><span class="p">]</span>
        <span class="n">utterance</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;utterance&#39;</span><span class="p">]</span>
        <span class="n">timing</span> <span class="o">=</span> <span class="n">ling_input</span><span class="p">[</span><span class="s">&#39;timing&#39;</span><span class="p">]</span>
        
        <span class="n">next_timing</span> <span class="o">=</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">next_timing</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utterance</span><span class="p">)):</span>          
            <span class="n">word_form</span> <span class="o">=</span> <span class="n">utterance</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;ling_input &lt;- t: </span><span class="si">%.1f</span><span class="s">, word_form: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">timing</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">word_form</span><span class="p">)</span>
            
            <span class="n">next_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>       
            <span class="k">if</span> <span class="n">next_idx</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">timing</span><span class="p">):</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="n">timing</span><span class="p">[</span><span class="n">next_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="k">yield</span> <span class="p">(</span><span class="n">word_form</span><span class="p">,</span> <span class="n">next_time</span><span class="p">)</span>
            
<span class="c">###############################################################################</span></div></div>
<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">test_TCG_production</span> <span class="kn">import</span> <span class="n">test2</span> <span class="k">as</span> <span class="n">test_production</span>
    <span class="kn">from</span> <span class="nn">test_TCG_comprehension</span> <span class="kn">import</span> <span class="n">test</span> <span class="k">as</span> <span class="n">test_comprehension</span>
    <span class="kn">from</span> <span class="nn">test_TCG_dyad</span> <span class="kn">import</span> <span class="n">test</span> <span class="k">as</span> <span class="n">test_dyad</span>
    
    <span class="n">test_production</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#    test_comprehension(seed=None)</span>
<span class="c">#    test_dyad(seed=0)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TCG 1.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Victor Barres.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3b3.
    </div>
  </body>
</html>